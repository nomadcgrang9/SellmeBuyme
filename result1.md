# 크롤러 배치 반복 방식 적용 결과

## 개요

기존 `batchSize=10` 고정 방식의 데이터 손실 문제를 해결하기 위해 **배치 반복 방식**을 도입했습니다.

### 기존 문제점
- `crawl_batch_size=10` 설정 시 최신 10개만 수집
- 하루에 신규 공고가 10개 이상이면 데이터 누락 발생
- 첫 크롤링 시 전체 공고의 극히 일부만 수집

### 새로운 배치 반복 방식
```
10개 수집 → 중복률 체크 → 낮으면 계속 → 50% 이상이면 종료
```

## 구현 상세

### SAFETY 설정 (공통)
```javascript
const SAFETY = {
  maxItems: 100,                // 절대 최대 수집 개수
  maxBatches: 10,               // 최대 배치 반복 횟수
  batchDuplicateThreshold: 0.5, // 배치 내 중복률 50% 이상이면 종료
  consecutiveDuplicateLimit: 3, // 연속 중복 시 즉시 중단
};
```

### 로직 흐름
1. 배치 크기만큼 항목 처리
2. 배치 완료 후 중복률 계산
3. 중복률 < 50%: 다음 배치 계속
4. 중복률 >= 50%: 기존 데이터 영역 도달, 크롤링 완료
5. 최대 배치 횟수(10회) 또는 최대 항목 수(100개) 도달 시 종료

## 수정된 크롤러 목록

| 크롤러 | 파일 | 패턴 | 수정 상태 |
|--------|------|------|----------|
| NTT 패턴 | `nttPattern.js` | selectNttList/selectNttInfo | ✅ 완료 |
| 세종교육청 | `sejong.js` | NTT 패턴 + 페이지 네비게이션 | ✅ 완료 |
| 강원교육청 | `gangwon.js` | 클릭 기반 네비게이션 | ✅ 완료 |
| 서울교육일자리 | `seoul.js` | q_rcrtSn 파라미터 | ✅ 완료 |
| 경기도교육청 | `gyeonggi.js` | POST 기반 | ✅ 완료 |
| 인천교육청 | `incheon.js` | data-id 기반 | ✅ 완료 |

## Chrome MCP 테스트 결과

### 세종특별자치시교육청
- URL: `https://www.sje.go.kr/sje/na/ntt/selectNttList.do?mi=52132&bbsId=108`
- 총 공고: 15,966건
- 페이지 구조: NTT 패턴 (selectNttList.do)
- 상태: ✅ 정상 작동

### 강원특별자치도교육청
- URL: `https://www.gwe.go.kr/main/bbs/list.do?key=bTIzMDcyMTA1ODU2MzM=`
- 총 공고: 3,425건
- 페이지 구조: 테이블 기반 목록
- 상태: ✅ 정상 작동

### 경기도교육청
- URL: `https://www.goe.go.kr/recruit/ad/func/pb/hnfpPbancList.do?mi=10502`
- 총 공고: 177건 (마감제외 기준)
- 페이지 구조: POST 기반 카드 레이아웃 (goView 패턴)
- 상태: ✅ 정상 작동

### 성남교육지원청 (NTT 패턴 대표)
- URL: `https://www.goesn.kr/goesn/na/ntt/selectNttList.do?mi=23603&bbsId=17872`
- 총 공고: 25,524건
- 페이지 구조: NTT 표준 패턴
- 상태: ✅ 정상 작동

## 예상 동작 시나리오

### 시나리오 1: 첫 크롤링 (DB 비어있음)
```
배치 1: 10개 신규, 0개 중복 (0%) → 계속
배치 2: 10개 신규, 0개 중복 (0%) → 계속
...
배치 10: 10개 신규, 0개 중복 (0%) → 최대 배치 도달
결과: 최대 100개 수집
```

### 시나리오 2: 일일 크롤링 (3개 신규)
```
배치 1: 3개 신규, 7개 중복 (70%) → 기존 영역 도달
결과: 3개 수집
```

### 시나리오 3: 일일 크롤링 (15개 신규)
```
배치 1: 10개 신규, 0개 중복 (0%) → 계속
배치 2: 5개 신규, 5개 중복 (50%) → 기존 영역 도달
결과: 15개 수집
```

## 출력 로그 예시

```
🔄 배치 반복 모드: 배치당 10개, 최대 10회
   중복률 50% 이상이면 종료

━━━ 배치 1 결과 ━━━
   신규: 10개, 중복: 0개
   중복률: 0% (임계값: 50%)
   → 🔄 중복률 낮음, 다음 배치 계속...

━━━ 배치 2 결과 ━━━
   신규: 3개, 중복: 7개
   중복률: 70% (임계값: 50%)
   → ✅ 기존 데이터 영역 진입 → 크롤링 완료

✅ 크롤링 완료
   - 신규: 13개
   - 중복 스킵: 7개
   - 총 처리: 20개
   - 배치 수: 2회
```

## 장점

1. **데이터 손실 방지**: 신규 공고가 많아도 중복 영역에 도달할 때까지 수집
2. **효율적 중단**: 기존 데이터 영역 도달 시 자동 종료
3. **안전장치**: 최대 100개, 최대 10배치로 무한 루프 방지
4. **연속 중복 감지**: 3개 연속 중복 시 즉시 종료로 빠른 판단
5. **명확한 로깅**: 배치별 결과와 중복률 실시간 확인

## 적용 교육청 목록 (NTT 패턴 공통)

nttPattern.js를 사용하는 교육청:
- 대구, 충북, 충남, 전남, 경북
- 성남, 의정부, 구리남양주
- 가평1, 가평2, 고양, 광명, 광주하남
- 김포, 동두천양주, 부천, 안성, 양평
- 연천, 파주, 평택, 포천

## 결론

배치 반복 방식 도입으로:
- ✅ 첫 크롤링 시 최대 100개까지 수집 가능
- ✅ 일일 크롤링 시 신규 공고 수에 관계없이 누락 없이 수집
- ✅ 기존 데이터와 중복되는 영역에서 자동 종료
- ✅ 불필요한 크롤링 시간 절약

---
생성일: 2026-01-10
