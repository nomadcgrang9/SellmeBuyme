# AI 추천 섹션 구현 계획

## 비전 및 핵심 요구사항
- **목적**: AI 추천 섹션을 통해 사용자 맞춤형 카드 노출과 서비스 홍보를 동시에 달성.
- **구성**: `AI 코멘트` 1개 + `추천 카드` 3장으로 고정.
- **토글 독립성**: 상단의 공고/인력/체험 전환과 무관하게 독립적인 추천 제공.
- **갱신 주기**: 하루 1회 고정 갱신, 결과 및 코멘트 캐싱.
- **카드 부족 대응**: 지역 범위를 순차적으로 확대하여 3장을 반드시 채움.

## 사용자 데이터 전략
- **위치 정보**
  - 회원가입 시 주 활동 지역 필수 저장.
  - 브라우저 Geolocation API 사용(권한 허용 시) → GPS/Wi-Fi/IP 기반 보정.
  - 우선순위: 설정 지역 → GPS → IP.
- **역할 정보**
  - 교사, 방과후 강사, 체험 프로그램 운영 등 다중 선택 허용.
  - 사용자 프로필에 배열 형태로 저장.
- **관심 지역**
  - 복수 등록 가능하도록 UI/DB 설계.
  - 추천 시 우선 대상 지역으로 활용.

## 추천 알고리즘 레이어
1. **지역 필터링**: 사용자 주 지역 + 인접 3개 시군(예: 수원 → 용인, 화성, 의왕).
2. **역할 매칭**: 선택한 역할별 선호 카테고리 가중치 적용.
3. **시간 요인**: 마감 임박, 신규 등록 카드에 추가 점수.
4. **행동 데이터**(향후): 검색/클릭 로그 기반 취향 반영.
5. **다양성 보장**: 서로 다른 카테고리가 포함되도록 조합.

## 추천 카드 선별 로직 아이디어
- **로직 A (역할 기반 믹스)**
  - 교사: 공고 1 + 인력 1 + 체험 1.
  - 교사+강사: 공고 1 + 인력 2.
  - 체험 운영자: 체험 2 + 공고 1.
- **로직 B (스코어링)**
  - `score = base + 지역(직접 100/인접 50) + 역할 매칭 80 + 마감임박 50 + 신규 30`.
  - 상위 스코어 3장을 선택하며 카테고리 중복 제한.
- **로직 C (Fallback 확대)**
  - 1차: 사용자 지역.
  - 2차: 인접 시군.
  - 3차: 인접 지역의 인접 지역.
  - 4차: 경기도 전체.

## AI 코멘트 생성 전략
- **도구**: Google Gemini API 활용, 하루 1회 호출 후 결과 캐싱.
- **톤**: 친절하고 행동 유도형(예: “방금 등록된 강사님 프로필을 먼저 안내드려요”).
- **프롬프트 예시**:
```text
당신은 초등교육 플랫폼의 AI 어시스턴트입니다.
사용자 역할: 초등교사, 추가 관심: 방과후 강의
사용자 지역: 수원시 (관심 지역: 용인, 화성)
추천 카드 목록: [카드A, 카드B, 카드C의 요약 정보]
친근한 30자 내외 추천 문구를 작성하세요.
```
- **실패 대비**: API 오류 시 기본 문구 준비 및 로그 기록.

## 데이터 및 캐싱 구조
- **프로필 테이블 (`profiles`)**
```sql
user_id uuid primary key references auth.users,
roles text[] not null,
primary_region text not null,
interest_regions text[] default '{}',
gps_location geography,
updated_at timestamp default now()
```
- **추천 결과 테이블 (`ai_recommendations`)**
```sql
id uuid primary key,
user_id uuid references auth.users,
card_ids uuid[3] not null,
comment text not null,
generated_at timestamp not null,
expires_at timestamp not null
```

## 실행 위치 및 API 흐름
- **Supabase Edge Function** `get-ai-recommendations`
  - 입력: `user_id`.
  - 처리: 프로필 조회 → 후보 카드 쿼리 → 스코어링/선별 → Gemini 호출 → 결과 저장.
  - 출력: `{ cards: [...3], comment: "..." }`.
  - 캐싱: `ai_recommendations`에 저장 후 24시간 이내 재사용.
- **프론트엔드**
  - 페이지 로드 시 Edge Function 호출.
  - 로딩/오류/비회원 상태 UI 처리.

## 구현 로드맵 (Phase)
- **Phase 1: 회원 시스템 정비**
  - Supabase Auth + 프로필 스키마.
  - 회원가입/프로필 UI (역할, 지역, 관심 지역, GPS 권한).
- **Phase 2: 추천 인프라 준비**
  - 행정구역 인접 데이터 JSON 정리.
  - Edge Function 기본 뼈대 구축.
  - 추천 결과 캐싱 구조 마련.
- **Phase 3: 추천 알고리즘 구현**
  - 지역/역할/시간 기반 스코어링.
  - 다양성 보장 및 Fallback 로직.
  - 비회원용 기본 추천 준비.
- **Phase 4: AI 코멘트 통합**
  - Gemini 연동 및 프롬프트 튜닝.
  - 캐싱 및 오류 대응.
- **Phase 5: 프론트엔드 연동**
  - 추천 섹션 API 연결 및 상태 표시.
  - UI 테스트 및 접근성 점검.
- **Phase 6: 테스트 & 모니터링**
  - 다양한 사용자 시나리오 QA.
  - 추천 품질 모니터링, 향후 행동 로그 도입 준비.

## 즉시 착수 가능한 작업
- **프로필/추천 테이블 마이그레이션 SQL 작성**.
- **행정구역 인접 관계 데이터 수집 및 구조화**.
- **회원가입 및 프로필 UI 와이어프레임 정리**.
- **Edge Function 스캐폴딩 및 캐싱 전략 설계**.
