# 지도-목록 실시간 연동 구현 플랜

> 작성일: 2026-01-30
> 최종 수정: 2026-01-30
> 목표: 지도에 보이는 마커들이 실시간으로 좌측 목록에 표시

---

## 1. 핵심 요구사항 (사용자 의도)

### 잘못 이해한 것 (X)
```
[공고 목록 탭] | [구직자 탭]  ← 탭 분리 X
```

### 올바른 이해 (O)
```
┌──────────────────────────────┐
│ 지도에 보이는 마커 목록       │  ← 하나의 통합 목록
│ (공고 + 구직자 + 강사 혼합)   │
└──────────────────────────────┘

지도 마커 = 목록 (1:1 실시간 연동)
```

---

## 2. 사용자가 원하는 동작

### 시나리오 1: 성남 지역 보는 중
```
지도:
  - 공고 마커: 5개
  - 구직자 마커: 2개
  - 강사 마커: 1개

목록 (8개 표시):
  ├─ 당당고등학교 (공고)
  ├─ 성남초등학교 (공고)
  ├─ 반짝이는 셀리 (구직자)
  ├─ 새콤한 라니아 (강사)
  ├─ 송림중학교 (공고)
  ├─ 수줍은 셀리 (구직자)
  ├─ ... (공고)
  └─ ... (공고)
```

### 시나리오 2: 지도를 광주로 이동
```
지도:
  - 공고 마커: 20개
  - 구직자 마커: 0개
  - 강사 마커: 0개

목록 (20개 표시):  ← 실시간 변경!
  ├─ 광주초등학교 (공고)
  ├─ 광주중학교 (공고)
  ├─ ...
  └─ (구직자/강사 없음 - 지도에도 없으니까)
```

### 시나리오 3: 필터로 "구직자만 보기" 선택
```
지도:
  - 공고 마커: 0개 (숨김)
  - 구직자 마커: 3개
  - 강사 마커: 0개 (숨김)

목록 (3개 표시):
  ├─ 반짝이는 셀리 (구직자)
  ├─ 수줍은 셀리 (구직자)
  └─ 느긋한 셀리 (구직자)
```

---

## 3. 핵심 원칙

| 원칙 | 설명 |
|------|------|
| **지도 = 목록** | 지도에 마커가 보이면 목록에도 보임 |
| **실시간 연동** | 지도 이동/줌 → 목록 자동 갱신 |
| **탭 분리 없음** | 공고/구직자/강사가 하나의 목록에 혼합 |
| **뷰포트 기반** | 현재 화면에 보이는 마커만 목록에 표시 |

---

## 4. 현재 문제점

### 4.1 탭 분리 (잘못됨)
```tsx
// 현재 구현 (잘못됨)
{panelTab === 'jobs' && ( <공고 목록> )}
{panelTab === 'seekers' && ( <구직자 목록> )}
```

### 4.2 실시간 연동 없음
```
- 지도 이동해도 목록 안 바뀜
- 마커가 없는 지역으로 이동해도 이전 목록 유지
```

### 4.3 뷰포트 필터링 미적용
```
- 공고는 viewportBounds 필터링 있음
- 구직자/강사는 뷰포트 필터링 없음
```

---

## 5. 수정 방향

### 5.1 탭 제거
```tsx
// 변경 전
[공고 목록 탭] | [구직자 탭]

// 변경 후
[목록] (탭 없음, 통합)
```

### 5.2 통합 목록 생성
```tsx
// 지도에 보이는 모든 마커 합치기
const visibleItems = [
  ...filteredJobPostings.map(job => ({ type: 'job', data: job })),
  ...visibleTeacherMarkers.map(m => ({ type: 'teacher', data: m })),
  ...visibleInstructorMarkers.map(m => ({ type: 'instructor', data: m })),
];
```

### 5.3 뷰포트 기반 필터링 (구직자/강사에도 적용)
```tsx
// 현재 지도 bounds 내의 마커만 필터링
const visibleTeacherMarkers = teacherMarkers.filter(marker => {
  return isInViewport(marker.latitude, marker.longitude, viewportBounds);
});

const visibleInstructorMarkers = instructorMarkers.filter(marker => {
  return isInViewport(marker.latitude, marker.longitude, viewportBounds);
});
```

### 5.4 지도 이동 시 목록 갱신
```tsx
// 지도 idle 이벤트에서 bounds 업데이트
map.addListener('idle', () => {
  const bounds = map.getBounds();
  setViewportBounds({
    sw: { lat: bounds.getSouthWest().getLat(), lng: bounds.getSouthWest().getLng() },
    ne: { lat: bounds.getNorthEast().getLat(), lng: bounds.getNorthEast().getLng() },
  });
});
```

---

## 6. 목록 UI 변경

### 변경 전 (탭 분리)
```
┌──────────────────────────────┐
│ [공고 목록 3] | [구직자 4]   │  ← 탭
├──────────────────────────────┤
│ (탭에 따라 다른 목록)         │
└──────────────────────────────┘
```

### 변경 후 (통합 목록)
```
┌──────────────────────────────┐
│ 목록                    7개  │  ← 탭 없음
├──────────────────────────────┤
│ ┌──────────────────────────┐ │
│ │ 당당고등학교       D-5   │ │  ← 공고 카드
│ │ 📍 경기 성남              │ │
│ └──────────────────────────┘ │
│ ┌──────────────────────────┐ │
│ │ 🟢 반짝이는 셀리  초등담임│ │  ← 구직자 카드
│ │    경력 5~10년           │ │
│ └──────────────────────────┘ │
│ ┌──────────────────────────┐ │
│ │ 🩷 새콤한 라니아  연수강사│ │  ← 강사 카드
│ │    에듀테크/AI           │ │
│ └──────────────────────────┘ │
│ ┌──────────────────────────┐ │
│ │ 성남초등학교       D-3   │ │  ← 공고 카드
│ │ 📍 경기 성남              │ │
│ └──────────────────────────┘ │
│ ...                          │
└──────────────────────────────┘
```

---

## 7. 카드 타입별 구분

| 타입 | 색상/아이콘 | 표시 정보 |
|------|-------------|-----------|
| 공고 | 기존 스타일 | 학교명, 제목, 위치, 마감일, D-day |
| 구직자 | 카테고리별 색상 원형 | 닉네임, 카테고리, 경력 |
| 강사 | 핑크 원형 + "연수강사" 배지 | 닉네임, 전문분야, 지역 |

---

## 8. 정렬 기준

통합 목록 정렬 옵션:
1. **거리순** (기본) - 현재 지도 중심에서 가까운 순
2. **마감임박순** - 공고만 해당, 구직자/강사는 하단 배치
3. **최신순** - created_at 기준

---

## 9. 구현 체크리스트

### Phase 1: 탭 제거 & 통합 목록
- [ ] panelTab 상태 제거
- [ ] 탭 UI 제거
- [ ] 통합 visibleItems 배열 생성
- [ ] 타입별 카드 렌더링

### Phase 2: 뷰포트 기반 필터링
- [ ] teacherMarkers 뷰포트 필터링 추가
- [ ] instructorMarkers 뷰포트 필터링 추가
- [ ] 지도 이동 시 목록 갱신 확인

### Phase 3: 실시간 연동 검증
- [ ] 지도 이동 → 목록 변경 확인
- [ ] 줌 인/아웃 → 목록 변경 확인
- [ ] 필터 토글 → 목록 변경 확인

---

## 10. 관련 파일

| 파일 | 수정 내용 |
|------|-----------|
| `Hero.tsx` | panelTab 제거, 통합 목록 구현, 뷰포트 필터링 |
| `MarkerPopup.tsx` | 변경 없음 (기존 재사용) |

---

## 11. 핵심 코드 변경 예시

```tsx
// 변경 전: 탭 분리
{panelTab === 'jobs' && <JobList />}
{panelTab === 'seekers' && <SeekerList />}

// 변경 후: 통합 목록
const visibleItems = useMemo(() => {
  const items = [];

  // 공고 (뷰포트 내)
  if (activeLayers.includes('job')) {
    items.push(...filteredJobPostings.map(job => ({
      type: 'job' as const,
      data: job,
      lat: job.latitude,
      lng: job.longitude,
    })));
  }

  // 구직자 (뷰포트 내)
  if (activeLayers.includes('teacher')) {
    const visible = teacherMarkers.filter(m =>
      isInViewport(m.latitude, m.longitude, viewportBounds)
    );
    items.push(...visible.map(m => ({
      type: 'teacher' as const,
      data: m,
      lat: m.latitude,
      lng: m.longitude,
    })));
  }

  // 강사 (뷰포트 내 + 조건 충족)
  if (showInstructorLayer || /* 기타 조건 */) {
    const visible = instructorMarkers.filter(m =>
      isInViewport(m.latitude, m.longitude, viewportBounds)
    );
    items.push(...visible.map(m => ({
      type: 'instructor' as const,
      data: m,
      lat: m.latitude,
      lng: m.longitude,
    })));
  }

  return items;
}, [filteredJobPostings, teacherMarkers, instructorMarkers, viewportBounds, activeLayers]);

// 렌더링
{visibleItems.map(item => {
  if (item.type === 'job') return <JobCard job={item.data} />;
  if (item.type === 'teacher') return <TeacherCard marker={item.data} />;
  if (item.type === 'instructor') return <InstructorCard marker={item.data} />;
})}
```

---

## 12. 필터 토글 동작 명확화

### 필터 토글 = 지도 + 목록 동시 적용
```
사용자가 "구직자만 보기" 클릭 시:
  - 지도: 구직자 마커만 표시 (공고/강사 마커 숨김)
  - 목록: 구직자 카드만 표시 (공고/강사 카드 숨김)

→ 지도와 목록은 항상 1:1 동기화
```

### 필터 토글 시나리오
| 필터 상태 | 지도 마커 | 목록 카드 |
|-----------|-----------|-----------|
| 전체 보기 | 공고 + 구직자 + 강사 | 공고 + 구직자 + 강사 |
| 공고만 보기 | 공고만 | 공고 카드만 |
| 구직자만 보기 | 구직자만 | 구직자 카드만 |
| 강사만 보기 | 강사만 | 강사 카드만 |

---

## 13. 카드 클릭 → 상세 표시 (근본적 재설계 필요)

### 🔴 현재 방식의 치명적 문제점

#### 문제 1: 마커 위치로 이동 불가
```
줌 아웃 상태 (60km 반경)에서 카드 클릭 시:
  - 예상: 마커 위치(분당)로 이동
  - 실제: 전혀 엉뚱한 위치로 이동 (인천 도촌동 등)
  - 원인: DB 좌표와 지도 표시 좌표 불일치?
```

#### 문제 2: 팝업이 마커를 가림
```
┌─────────────────────────────┐
│          지도                │
│                             │
│     ┌─────────┐             │
│     │  팝업   │  ← 마커를 완전히 가림
│     │         │             │
│     └─────────┘             │
│        (마커)                │
└─────────────────────────────┘
```

#### 문제 3: 화면 좌표 계산 불안정
- `rect.width / 2 + offset` 방식은 줌 레벨, 패닝 상태에 따라 결과 상이
- idle 이벤트 타이밍 문제
- 지도 컨테이너 크기 변경 시 오차 발생

---

## 14. 공고 마커 클릭 vs 구직자/강사 마커 클릭 비교

### ✅ 공고 카드 클릭 (정상 작동)

```
┌──────────────────────────────────────────────────────┐
│ ┌───────┐ ┌─────────────┐                           │
│ │ 목록  │ │ 상세 패널   │        지도              │
│ │       │ │             │                           │
│ │ 카드1 │ │ 당당고등학교│        🏫 (마커)          │
│ │ 카드2 │ │ 채용공고...  │                           │
│ │ ...   │ │             │                           │
│ └───────┘ └─────────────┘                           │
└──────────────────────────────────────────────────────┘
         ↑ flex 아이템으로 배치 (지도 위 플로팅 아님)
```

**구현 방식 (handleCardClick):**
```tsx
const handleCardClick = useCallback((job: JobPostingCard) => {
  // 1. 상세 패널 표시
  setSelectedJob(job);

  // 2. 지도 이동 (좌표 우선순위)
  // 1순위: 실제 마커 좌표 (jobMarkerCoordsRef)
  const markerCoords = jobMarkerCoordsRef.current.get(job.id);
  if (markerCoords) {
    moveMapToCoords(markerCoords.lat, markerCoords.lng);
    return;
  }

  // 2순위: DB 좌표
  if (job.latitude && job.longitude) {
    moveMapToCoords(job.latitude, job.longitude);
    return;
  }

  // 3순위: 캐시 좌표
  // 4순위: Places API 검색
}, []);

// 지도 이동 함수 (단순!)
const moveMapToCoords = useCallback((lat: number, lng: number) => {
  map.setCenter(new kakao.maps.LatLng(lat, lng));  // panTo가 아닌 setCenter
  map.setLevel(3);
}, []);

// JobDetailPanel은 flex 아이템으로 목록 옆에 표시
{selectedJob && (
  <div data-panel="detail">
    <JobDetailPanel job={selectedJob} onClose={() => setSelectedJob(null)} />
  </div>
)}
```

**핵심 포인트:**
- ✅ `setCenter()` 사용 (panTo 애니메이션 아님 → idle 이벤트 불필요)
- ✅ 좌표 우선순위 시스템 (마커좌표 → DB좌표 → 캐시 → API검색)
- ✅ 상세 패널은 flex 아이템 (화면 좌표 계산 불필요)
- ✅ 마커를 가리지 않음
- ✅ 안정적 작동

---

### ❌ 구직자/강사 카드 클릭 (문제 많음)

```
┌──────────────────────────────────────────────────────┐
│ ┌───────┐                                           │
│ │ 목록  │              지도                         │
│ │       │       ┌─────────────┐                     │
│ │ 카드1 │       │ MarkerPopup │  ← 플로팅 팝업      │
│ │ 카드2 │       │ (x, y 좌표) │                     │
│ │ ...   │       └─────────────┘                     │
│ └───────┘           (마커)  ← 가려짐               │
└──────────────────────────────────────────────────────┘
```

**현재 구현 방식 (문제 있음):**
```tsx
// 1. selectedMarker 상태 (position 화면좌표 포함)
const [selectedMarker, setSelectedMarker] = useState<{
  type: 'teacher' | 'instructor';
  marker: TeacherMarker | InstructorMarker;
  position: { x: number; y: number };  // ← 문제의 원인!
} | null>(null);

// 2. 카드 클릭 핸들러 (공고와 완전히 다른 방식)
onClick={() => {
  setSelectedMarker(null);  // 기존 팝업 닫기

  // panTo 사용 (setCenter 아님!) → 애니메이션 발생 → idle 대기 필요
  map.panTo(coords);
  map.setLevel(4);

  // idle 리스너 등록 + setTimeout 폴백
  const showPopup = () => {
    // 화면 좌표 계산 (불안정!)
    const rect = mapContainerRef.current.getBoundingClientRect();
    setSelectedMarker({
      type: 'teacher',
      marker,
      position: {
        x: rect.width / 2 + 100,   // ← 고정 오프셋
        y: rect.height / 2 - 60    // ← 줌 레벨과 무관
      }
    });
  };
  window.kakao.maps.event.addListener(map, 'idle', showPopup);
  setTimeout(showPopup, 400);  // 폴백
}}

// 3. MarkerPopup은 absolute 포지션으로 지도 위에 플로팅
<MarkerPopup
  position={selectedMarker.position}  // left, top으로 배치
  ...
/>
```

**공고 방식과의 차이점:**
| 구분 | 공고 (정상) | 구직자/강사 (문제) |
|------|-------------|-------------------|
| 지도 이동 | `setCenter()` | `panTo()` (애니메이션) |
| 이벤트 대기 | 불필요 | idle 이벤트 필요 |
| 좌표 시스템 | 마커좌표→DB→캐시→API | DB 좌표만 |
| 상세 표시 | flex 아이템 (패널) | absolute (플로팅) |
| 화면좌표 계산 | 불필요 | 필요 (불안정) |

**문제점:**
- ❌ `panTo()` 사용 → idle 이벤트 타이밍 불안정
- ❌ 좌표 우선순위 시스템 없음 (DB 좌표가 없거나 틀리면 실패)
- ❌ 화면 좌표 계산이 줌/뷰포트 상태와 무관한 고정값
- ❌ 팝업이 마커를 가림 (flex가 아닌 absolute)
- ❌ 모바일에서 더 심각

---

## 15. 해결 방안: 공고 방식 통일

### 제안: 공고와 동일한 패턴으로 구현

```
┌──────────────────────────────────────────────────────┐
│ ┌───────┐ ┌─────────────┐                           │
│ │ 목록  │ │ 상세 패널   │        지도              │
│ │       │ │             │                           │
│ │ 공고1 │ │ 수줍은 셀리 │        🟢 (구직자 마커)  │
│ │ 구직1 │ │ 국어/초등담임│                           │
│ │ 강사1 │ │ 경력 1~3년  │                           │
│ │ ...   │ │             │                           │
│ └───────┘ └─────────────┘                           │
└──────────────────────────────────────────────────────┘
```

### 구현 계획

#### Step 1: 상태 변경 (공고와 동일한 패턴)
```tsx
// Before - position 좌표 포함 (문제)
const [selectedMarker, setSelectedMarker] = useState<{
  type: 'teacher' | 'instructor';
  marker: TeacherMarker | InstructorMarker;
  position: { x: number; y: number };  // 삭제!
} | null>(null);

// After - 공고처럼 단순하게
const [selectedTeacher, setSelectedTeacher] = useState<TeacherMarker | null>(null);
const [selectedInstructor, setSelectedInstructor] = useState<InstructorMarker | null>(null);
```

#### Step 2: 상세 패널 컴포넌트 생성
```tsx
// TeacherDetailPanel.tsx - JobDetailPanel 구조 복제
export function TeacherDetailPanel({
  teacher,
  onClose
}: {
  teacher: TeacherMarker;
  onClose: () => void;
}) {
  return (
    <div className="w-[280px] bg-white rounded-xl shadow-lg overflow-hidden">
      {/* 헤더: 닉네임, 닫기 버튼 */}
      {/* 프로필 이미지 */}
      {/* 카테고리, 경력 */}
      {/* 이메일 연락 */}
      {/* 좋아요, 후기 */}
    </div>
  );
}
```

#### Step 3: 카드 클릭 핸들러 (공고와 동일하게)
```tsx
// 공고 handleCardClick과 동일한 패턴
const handleTeacherCardClick = useCallback((marker: TeacherMarker) => {
  // 토글
  if (selectedTeacher?.id === marker.id) {
    setSelectedTeacher(null);
    return;
  }

  // 1. 상세 패널 표시
  setSelectedTeacher(marker);

  // 2. 지도 이동 (setCenter 사용, panTo 아님!)
  if (marker.latitude && marker.longitude) {
    moveMapToCoords(marker.latitude, marker.longitude);
  }
}, [selectedTeacher, moveMapToCoords]);
```

#### Step 4: 레이아웃 통합 (flex 아이템으로)
```tsx
{/* 상세 패널 - 카드 목록 옆에 배치 (flex) */}
{selectedJob && <JobDetailPanel job={selectedJob} ... />}
{selectedTeacher && <TeacherDetailPanel teacher={selectedTeacher} ... />}
{selectedInstructor && <InstructorDetailPanel instructor={selectedInstructor} ... />}
```

#### Step 5: MarkerPopup 제거
```tsx
// Before - 불안정한 플로팅 팝업
{selectedMarker && (
  <MarkerPopup position={selectedMarker.position} ... />  // 삭제!
)}

// After - selectedMarker 상태 자체를 제거하고 TeacherDetailPanel로 대체
```

---

## 16. 마커 클릭 시 동작 정의

### 지도에서 직접 마커 클릭
```
사용자가 지도의 구직자 마커 직접 클릭
    ↓
setSelectedTeacher(marker)
    ↓
오른쪽에 TeacherDetailPanel 표시
    ↓
목록에서 해당 카드로 스크롤
    ↓
(지도 이동 없음 - 이미 해당 위치 보는 중)
```

### 목록에서 카드 클릭
```
사용자가 왼쪽 목록의 구직자 카드 클릭
    ↓
setSelectedTeacher(marker)
    ↓
오른쪽에 TeacherDetailPanel 표시
    ↓
지도가 해당 마커 위치로 panTo (선택적)
    ↓
(팝업 좌표 계산 불필요!)
```

---

## 17. 구현 체크리스트 (업데이트)

### Phase 4: 상세 패널 통일 (신규)
- [ ] `TeacherDetailPanel.tsx` 생성
- [ ] `InstructorDetailPanel.tsx` 생성
- [ ] `selectedTeacher`, `selectedInstructor` 상태 추가
- [ ] `MarkerPopup` 사용 제거 (teacher/instructor용)
- [ ] 카드 클릭 핸들러 간소화
- [ ] 마커 클릭 핸들러 수정 (setSelectedTeacher 호출)
- [ ] 레이아웃 flex 아이템으로 통합

---

**작성자**: Claude
**상태**: 근본적 재설계 필요 - 공고 방식으로 통일 권장
**최종 수정**: 2026-01-30
