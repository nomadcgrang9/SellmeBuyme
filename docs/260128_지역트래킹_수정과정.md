# 260128 지역 트래킹 수정 과정

> 작성일: 2026-01-28
> 상태: 테스트 대기 중 (미검증)

---

## 1. 최초 문제 제기

사용자가 관리자 대시보드에서 **지역별 접속 현황이 모두 0명**으로 표시되는 문제 발견.
- 시크릿 모드에서 위치 "허용" 클릭 후에도 변화 없음
- DAU/WAU/MAU는 정상 표시 (Edge Function 401 문제 해결 후)

---

## 2. 1차 조사: 트래킹 코드 누락 발견

### 발견 사항
- `useActivityTracking` 훅이 **레거시 App.tsx에서만 호출**되고 있었음
- 실제 메인 페이지인 **NewLanding (`/` 경로)에는 트래킹 코드 없음**

### main.tsx 라우팅 구조
```
/ (기본 경로) → NewLanding     ← ❌ useActivityTracking 없음!
/legacy, /old → App.tsx        ← ✅ useActivityTracking 있음
```

### 1차 수정 (커밋: 55aac51)
**파일**: `src/pages/new-landing/App.tsx`
```typescript
import { useActivityTracking } from '@/lib/hooks/useActivityTracking';

const App: React.FC = () => {
  useActivityTracking();  // 추가
  return (...);
};
```

---

## 3. 2차 조사: Edge Function 401 에러

### 발견 사항
- Supabase Edge Function `dashboard-analytics` 호출 시 401 Unauthorized
- 원인: Supabase 대시보드에서 "Verify JWT with legacy secret" 옵션 활성화

### 해결
- 사용자가 Supabase 대시보드에서 해당 옵션 비활성화
- DAU/WAU/MAU 정상 표시 확인

---

## 4. 3차 조사: 지역 트래킹 여전히 실패

### DB 조회 결과
```sql
SELECT metadata->>'region_city', COUNT(*)
FROM user_activity_logs
GROUP BY metadata->>'region_city';

-- 결과: 505건 모두 region_city = NULL
```

**모든 page_view 레코드에 지역 정보가 없음!**

---

## 5. 근본 원인 분석

### 문제 1: useGeolocation 훅 미사용
- NewLanding에서 `useGeolocation` 훅을 호출하지 않음
- Hero.tsx에서 자체적으로 geolocation 처리하지만:
  - 잘못된 localStorage 키 사용: `userLocation` (올바른 키: `user_location`)
  - 잘못된 데이터 구조: `{ lat, lng }` (올바른 구조: `{ address: { city, district } }`)
  - `reverseGeocode()` 미호출: 좌표 → 주소 변환 없음

### 문제 2: 타이밍 이슈
```
1. 페이지 로드
2. useActivityTracking() 즉시 실행 → localStorage 비어있음 → region: null로 기록
3. 위치 권한 팝업 표시
4. 사용자 "허용" 클릭
5. 위치 저장 (이미 늦음 - page_view는 이미 기록됨)
```

### 문제 3: 지역 분류 체계 불일치
**대시보드 기대값 (RegionStats.tsx)**:
```typescript
ALL_REGIONS = ['서울', '부산', '대구', '인천', '광주', '대전', '울산', '세종',
               '경기', '강원', '충북', '충남', '전북', '전남', '경북', '경남', '제주']
```

**기존 geocoding.ts 저장값**:
```typescript
// Kakao API 응답:
// region_1depth_name: "경기도" ← 광역시/도
// region_2depth_name: "성남시" ← 시/군
// region_3depth_name: "분당구" ← 구/동

city: "성남"     // ❌ region_2depth_name 사용
district: "분당" // ❌ region_3depth_name 사용
```

**불일치**: 대시보드는 `"경기"` 기대, 저장값은 `"성남"` → 매칭 안 됨!

---

## 6. 수정 내역

### 수정 1: NewLanding에 useGeolocation 추가 (커밋: 986c4bb)

**파일**: `src/pages/new-landing/App.tsx`
```typescript
import { useGeolocation } from '@/lib/hooks/useGeolocation';

const App: React.FC = () => {
  useGeolocation();       // 추가 - localStorage에 user_location 저장
  useActivityTracking();  // 기존
  return (...);
};
```

### 수정 2: geocoding.ts 광역시/도 레벨로 변경 (커밋: a23e845)

**파일**: `src/lib/utils/geocoding.ts`

**Before**:
```typescript
const city = address.region_2depth_name.replace(/시$/, ''); // "성남"
const district = address.region_3depth_name.replace(/구$/, ''); // "분당"
```

**After**:
```typescript
const province = address.region_1depth_name
  .replace(/특별시$/, '')
  .replace(/광역시$/, '')
  .replace(/특별자치시$/, '')
  .replace(/특별자치도$/, '')
  .replace(/도$/, ''); // "경기도" → "경기"
const city = address.region_2depth_name.replace(/시$|군$/, ''); // "성남시" → "성남"

return {
  city: province,   // "경기" (대시보드 ALL_REGIONS와 매칭)
  district: city,   // "성남"
};
```

### 수정 3: useActivityTracking 위치 대기 로직 추가 (커밋: a23e845)

**파일**: `src/lib/hooks/useActivityTracking.ts`

**추가된 함수**:
```typescript
// 지역 정보가 localStorage에 저장될 때까지 대기 (최대 3초)
const waitForRegionInfo = async (maxWaitMs = 3000, intervalMs = 300) => {
  const startTime = Date.now();

  // 즉시 확인
  let regionInfo = getRegionInfo();
  if (regionInfo.city) {
    return regionInfo;
  }

  // 폴링으로 대기
  return new Promise((resolve) => {
    const checkInterval = setInterval(() => {
      regionInfo = getRegionInfo();

      if (regionInfo.city) {
        clearInterval(checkInterval);
        resolve(regionInfo);
        return;
      }

      if (Date.now() - startTime >= maxWaitMs) {
        clearInterval(checkInterval);
        resolve(regionInfo);
      }
    }, intervalMs);
  });
};
```

**trackActivity 함수 수정**:
```typescript
// page_view일 경우 위치 정보를 기다림 (최대 3초)
const regionInfo = actionType === 'page_view'
  ? await waitForRegionInfo(3000, 300)
  : getRegionInfo();
```

### 수정 4: Fallback 함수도 광역시/도 레벨로 변경

**파일**: `src/lib/utils/geocoding.ts`

```typescript
function getCityFromCoordinates(lat: number, lng: number): KakaoAddress {
  const provinceRanges = [
    { province: '서울', lat: [37.45, 37.65], lng: [126.8, 127.2] },
    { province: '인천', lat: [37.35, 37.55], lng: [126.5, 126.8] },
    { province: '경기', lat: [36.9, 38.2], lng: [126.5, 127.8] },
    // ... 17개 광역시/도 전체
  ];

  for (const range of provinceRanges) {
    if (lat >= range.lat[0] && lat <= range.lat[1] &&
        lng >= range.lng[0] && lng <= range.lng[1]) {
      return { city: range.province, district: '' };
    }
  }
  return { city: '', district: '' };
}
```

---

## 7. 수정 후 예상 데이터 흐름

```
1. 사용자 페이지 접속
2. useGeolocation() 실행 → 위치 권한 팝업 표시
3. useActivityTracking() 실행 → waitForRegionInfo() 대기 시작 (최대 3초)
4. 사용자 "허용" 클릭 (보통 1-2초)
5. Kakao API 호출 → "경기도 성남시 분당구"
6. 정규화 → city: "경기", district: "성남"
7. localStorage('user_location') 저장
8. waitForRegionInfo() 감지 → 즉시 반환
9. page_view INSERT (region_city: "경기", region_district: "성남")
10. 대시보드에서 "경기" 지역 카운트 증가 ✅
```

---

## 8. 커밋 히스토리

| 커밋 | 내용 |
|------|------|
| 55aac51 | feat(tracking): 메인 페이지(NewLanding)에 사용자 활동 트래킹 추가 |
| 986c4bb | fix(tracking): 지역 트래킹 수정 - useGeolocation 훅 추가 |
| a23e845 | fix(tracking): 지역 트래킹 근본 수정 (광역시/도 레벨 + 대기 로직) |

---

## 9. 2차 수정 (2026-01-28 21:00)

### 발견된 문제

DB 조회 결과 **509건 모두 `region_city = null`** 확인.
1차 수정에도 불구하고 지역 정보가 전혀 저장되지 않음.

### 근본 원인 3가지

| 버그 | 위치 | 문제 |
|------|------|------|
| #1 | `geocoding.ts:47` | Kakao API의 `address`가 null일 수 있음 (지번 주소 없는 경우) → TypeError |
| #2 | `useGeolocation.ts:86-95` | catch 블록에서 localStorage 저장 안 함 → 항상 빈 값 |
| #3 | `useActivityTracking.ts` | 3초 타임아웃이 너무 짧음 (허용 클릭 + API 응답 시간) |

### 수정 내역

**파일 1: `src/lib/utils/geocoding.ts`**
- `address`가 null일 경우 `road_address`를 fallback으로 사용
- `KakaoGeocodingResponse` 인터페이스에 `road_address` 타입 추가
- 둘 다 없으면 좌표 기반 fallback 함수 사용

**파일 2: `src/lib/hooks/useGeolocation.ts`**
- catch 블록에서도 fallback 주소를 localStorage에 저장
- 이전: catch 시 setState만 호출, localStorage 미저장
- 이후: catch 시에도 localStorage 저장 (빈 값이라도)

**파일 3: `src/lib/hooks/useActivityTracking.ts`**
- 타임아웃: 3초 → 10초 (사용자가 허용 누르는 시간 확보)
- 폴링 간격: 300ms → 200ms (더 빠른 감지)
- 디버깅 로그 추가

---

## 10. 테스트 체크리스트

- [ ] 시크릿 모드에서 학교일자리.com 접속
- [ ] 위치 권한 "허용" 클릭
- [ ] 10초 대기 (트래킹 완료)
- [ ] 콘솔에서 `[ActivityTracking] 지역 정보 발견: 경기` 로그 확인
- [ ] DB 조회: `SELECT metadata->>'region_city' FROM user_activity_logs ORDER BY created_at DESC LIMIT 5;`
- [ ] region_city가 "경기", "서울" 등 광역시/도 이름으로 저장되었는지 확인
- [ ] 대시보드 지역별 접속 현황에 데이터 표시되는지 확인

---

## 11. 잔여 이슈

1. **위치 권한 거부 시**: region은 빈 값으로 저장됨 (의도된 동작)
2. **10초 내 허용 안 할 경우**: region은 빈 값으로 저장됨 (타임아웃)
3. **VPN 사용자**: Kakao API가 잘못된 위치 반환 가능
4. **해외 접속**: 좌표 기반 fallback에서 빈 값 반환

---

*작성: Claude Code*
*최종 수정: 2026-01-28 21:00 KST*

