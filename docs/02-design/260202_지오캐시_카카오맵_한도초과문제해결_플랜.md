# Geocache 구현 플랜 - 카카오맵 API 한도 초과 문제 해결

**작성일**: 2026-02-02
**상태**: 계획 수립
**긴급도**: 높음 (서비스 중단 상태)

---

## 1. 문제 상황

### 현황
| 지표 | 값 |
|------|-----|
| 총 공고 수 | 7,192개 |
| 고유 학교명 | 3,587개 |
| 좌표 있는 공고 | 2개 (수동 입력) |
| 좌표 없는 공고 | 7,190개 |

### 문제 원인
```
사용자 접속 → 학교명으로 Kakao Places API 호출 → 좌표 획득 → 마커 표시
                          ↓
            200명 × 300개 공고 = 60,000+ API 호출/일
                          ↓
            일일 쿼터 100,000 초과 → API 차단 → 마커 미표시
```

### API 사용량 (2월 1일)
- 성공: 132,796회
- 실패: 1,102,585회 (할당량 초과)
- 에러율: 89%

---

## 2. 해결 방안: Geocache 테이블

### 개념
```
Before: 사용자마다 카카오에 "학교 어디야?" 질문 (중복)
After:  한 번 물어본 학교는 DB에 저장 → 다음부터 DB에서 조회
```

### 기대 효과
| 항목 | Before | After |
|------|--------|-------|
| 학교당 API 호출 | 사용자 수만큼 | **1회 (최초 1회만)** |
| 일일 API 호출량 | 100,000+ | **최대 3,587회** |
| 재방문자 API 호출 | 매번 호출 | **0회** |

---

## 3. 구현 계획

### Phase 1: 테이블 생성 (10분)

**geocache 테이블 스키마**
```sql
CREATE TABLE geocache (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  organization VARCHAR(255) NOT NULL UNIQUE,  -- 학교/기관명
  latitude DECIMAL(10, 8) NOT NULL,
  longitude DECIMAL(11, 8) NOT NULL,
  source VARCHAR(50) DEFAULT 'kakao',  -- 출처 (kakao, neis, manual)
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 인덱스
CREATE INDEX idx_geocache_organization ON geocache(organization);

-- RLS 정책
ALTER TABLE geocache ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Anyone can read geocache" ON geocache FOR SELECT USING (true);
CREATE POLICY "Authenticated can insert geocache" ON geocache FOR INSERT WITH CHECK (true);
```

### Phase 2: API 함수 생성 (20분)

**src/lib/supabase/geocache.ts**
```typescript
// 1. 캐시 조회
export async function getGeocache(organization: string): Promise<{lat, lng} | null>

// 2. 캐시 저장
export async function saveGeocache(organization: string, lat: number, lng: number): Promise<void>

// 3. 여러 학교 일괄 조회
export async function getGeocacheBatch(organizations: string[]): Promise<Map<string, {lat, lng}>>
```

### Phase 3: Hero.tsx 수정 (30분)

**마커 생성 로직 변경**
```
현재 흐름:
1. localStorage 캐시 확인
2. 없으면 → Kakao API 호출
3. localStorage에 저장

변경 후:
1. localStorage 캐시 확인 (빠른 응답용)
2. 없으면 → Supabase geocache 조회 (서버 캐시)
3. 없으면 → Kakao API 호출
4. 결과를 geocache + localStorage 모두 저장
```

### Phase 4: 기존 데이터 마이그레이션 (선택)

**배치 스크립트로 기존 학교 좌표 채우기**
- 3,587개 학교를 배치로 geocoding
- 하루 1,000개씩 처리 (API 한도 고려)
- 또는 NEIS API 활용 (무료)

---

## 4. 파일 변경 목록

| 파일 | 작업 |
|------|------|
| `supabase/migrations/260202_create_geocache.sql` | 신규 생성 |
| `src/lib/supabase/geocache.ts` | 신규 생성 |
| `src/pages/new-landing/components/Hero.tsx` | 수정 |
| `src/types/index.ts` | 타입 추가 (선택) |

---

## 5. 구현 순서

```
[1] 마이그레이션 파일 작성 및 적용 (10분)
    ↓
[2] geocache.ts API 함수 작성 (20분)
    ↓
[3] Hero.tsx 마커 생성 로직 수정 (30분)
    ↓
[4] 로컬 테스트 (10분)
    ↓
[5] 빌드 & 배포 (5분)
    ↓
[6] 점검 모드 해제 (MaintenancePage.tsx)
    ↓
[7] 프로덕션 모니터링
```

**예상 소요 시간: 약 1.5시간**

---

## 6. 테스트 계획

### 로컬 테스트
- [ ] geocache 테이블 생성 확인
- [ ] geocache 조회/저장 함수 동작 확인
- [ ] Hero.tsx에서 geocache 우선 조회 확인
- [ ] Kakao API 호출 시 geocache 저장 확인
- [ ] 콘솔에서 캐시 히트/미스 로그 확인

### 프로덕션 테스트
- [ ] 마커 정상 표시 확인
- [ ] API 호출량 감소 확인 (카카오 콘솔)
- [ ] geocache 테이블 데이터 증가 확인

---

## 7. 롤백 계획

문제 발생 시:
1. `MAINTENANCE_MODE = true`로 점검 모드 재활성화
2. Hero.tsx에서 geocache 로직 주석 처리
3. 기존 localStorage 캐시만 사용하도록 복구

---

## 8. 후속 작업 (이번 주)

1. **크롤러 수정**: 공고 저장 시 geocache 확인 → 없으면 geocoding 후 저장
2. **배치 스크립트**: 기존 3,587개 학교 일괄 geocoding
3. **NEIS API 연동**: 무료 학교 좌표 데이터 활용 검토

---

## 9. 체크리스트

- [ ] Phase 1: geocache 테이블 생성
- [ ] Phase 2: geocache.ts API 함수 작성
- [ ] Phase 3: Hero.tsx 수정
- [ ] Phase 4: 로컬 테스트
- [ ] Phase 5: 빌드 & 배포
- [ ] Phase 6: 점검 모드 해제
- [ ] Phase 7: 모니터링
