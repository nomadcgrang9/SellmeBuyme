# 260128 사용자통계 개선플랜

> 작성일: 2026-01-28
> 목표: 사용자 접속 통계 시스템 정상화

---

## 1. 현황 진단 (실제 테스트 결과)

### 1.1 대시보드 현황 (프로덕션 직접 확인)

**테스트 URL**: `https://학교일자리.com/sellba-x7k9m2-team-console-2025`

| 지표 | 값 | 상태 |
|------|-----|------|
| DAU (일간 활성 사용자) | **0명** | ❌ |
| WAU (주간 활성 사용자) | **0명** | ❌ |
| MAU (월간 활성 사용자) | **0명** | ❌ |
| 재방문율 (D7) | **0%** | ❌ |
| 지역별 접속 현황 | **모두 0명** | ❌ |

**표시 메시지**: "아직 수집된 방문 데이터가 없습니다. 사용자 방문이 쌓이면 여기에 실제 통계가 표시됩니다."

### 1.2 콘솔 에러 (프로덕션)

```
❌ Failed to load resource: dashboard-analytics (500 또는 연결 실패)
❌ 대시보드 Edge Function 호출 실패: FunctionsHttpError
❌ fetchDashboardAnalytics 오류: FunctionsHttpError
```

---

## 2. 근본 원인 분석

### 2.1 문제 1: 메인 페이지에서 트래킹 미적용 ⚠️ 치명적

**main.tsx 라우팅 구조:**
```
사용자 접속 → main.tsx 라우팅 결정
    │
    ├── / (기본 경로) → NewLanding     ← ❌ useActivityTracking 없음!
    ├── /legacy, /old → App.tsx        ← ✅ useActivityTracking 있음
    ├── /note → DeveloperPage          ← ❌ 트래킹 없음
    ├── /admin* → AdminPage            ← ❌ 트래킹 없음
    ├── /search → MobileSearch         ← ❌ 트래킹 없음
    ├── /register → MobileRegister     ← ❌ 트래킹 없음
    └── /chat* → MobileChat*           ← ❌ 트래킹 없음
```

**핵심 문제:**
- `useActivityTracking` 훅은 **오직 `App.tsx`에서만 호출**
- 실제 사용자 99%는 **NewLanding (`/`)에 접속**
- NewLanding의 `src/pages/new-landing/App.tsx`에는 트래킹 코드가 **전혀 없음**

**증거 (Playwright 테스트):**
- 메인 페이지 접속 후 콘솔에서 `ActivityTracking` 관련 로그 **0건**
- `trackActivity`, `page_view`, `activity` 키워드 검색 결과 **없음**

### 2.2 문제 2: Edge Function 호출 실패

**dashboard-analytics Edge Function 상태:**
- 프로덕션에서 **500 에러** 또는 **연결 실패**
- `FunctionsHttpError` 발생

**가능한 원인:**
1. Edge Function 미배포
2. 환경변수 미설정 (`SUPABASE_SERVICE_ROLE_KEY`)
3. 함수 코드 오류
4. Supabase 프로젝트 설정 문제

### 2.3 문제 3: localStorage 지역 정보 (이미 수정됨)

**v2 문서에서 언급한 이슈 → 이미 수정 완료**

```typescript
// useActivityTracking.ts Line 37-38 (현재 코드)
city: parsed.address?.city || undefined,      // ✅ 수정됨
district: parsed.address?.district || undefined, // ✅ 수정됨
```

---

## 3. 코드 상세 분석

### 3.1 NewLanding 구조

**파일**: `src/pages/new-landing/App.tsx`
```typescript
import React from 'react';
import { Hero } from './components/Hero';
import { PWAProvider } from '@/components/pwa';

const App: React.FC = () => {
  return (
    <PWAProvider>
      <div className="h-screen w-screen overflow-hidden">
        <Hero />   // ← 지도 + 바텀시트
      </div>
    </PWAProvider>
  );
};
```

**문제점:**
- `useActivityTracking` import 없음
- `trackActivity` 호출 없음
- 사용자 방문이 전혀 기록되지 않음

### 3.2 트래킹 시스템 구조

```
┌──────────────────────────────────────────────────────────────────┐
│                         데이터 수집 (프론트엔드)                    │
├──────────────────────────────────────────────────────────────────┤
│                                                                   │
│  useActivityTracking.ts (훅)                                      │
│    └─ trackActivity() 함수                                        │
│         ├─ getSessionId() → sessionStorage                        │
│         ├─ getDeviceType() → window.innerWidth 기반               │
│         ├─ getRegionInfo() → localStorage.user_location           │
│         └─ INSERT INTO user_activity_logs                         │
│                                                                   │
│  ⚠️ 이 훅은 App.tsx에서만 호출됨 (NewLanding에서 미호출)            │
│                                                                   │
└──────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────────┐
│                       데이터 저장 (Supabase)                       │
├──────────────────────────────────────────────────────────────────┤
│                                                                   │
│  user_activity_logs 테이블                                        │
│    ├─ id (UUID)                                                   │
│    ├─ user_id (nullable - 비로그인 허용)                           │
│    ├─ action_type ('page_view', 'search', etc.)                  │
│    ├─ metadata (JSONB)                                            │
│    │    ├─ session_id                                             │
│    │    ├─ device_type                                            │
│    │    ├─ region_city      ← 위치 허용 시                         │
│    │    ├─ region_district  ← 위치 허용 시                         │
│    │    ├─ page_path                                              │
│    │    └─ user_agent                                             │
│    └─ created_at                                                  │
│                                                                   │
│  ⚠️ 현재 데이터 0건 (트래킹 미적용으로 인해)                         │
│                                                                   │
└──────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────────┐
│                     데이터 조회 (Edge Function)                    │
├──────────────────────────────────────────────────────────────────┤
│                                                                   │
│  supabase/functions/dashboard-analytics/index.ts                  │
│    ├─ SERVICE_ROLE_KEY로 RLS 우회                                 │
│    ├─ user_activity_logs에서 page_view 조회                       │
│    ├─ DAU/WAU/MAU 계산 (세션 기반)                                 │
│    ├─ 시간대별/디바이스별/지역별 분포 계산                           │
│    └─ JSON 응답 반환                                               │
│                                                                   │
│  ⚠️ 프로덕션에서 FunctionsHttpError 발생 중                        │
│                                                                   │
└──────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────────┐
│                      데이터 표시 (대시보드)                         │
├──────────────────────────────────────────────────────────────────┤
│                                                                   │
│  DashboardOverview.tsx                                            │
│    └─ fetchDashboardAnalytics() 호출                              │
│         └─ supabase.functions.invoke('dashboard-analytics')       │
│                                                                   │
│  현재 상태: 모든 지표 0                                             │
│                                                                   │
└──────────────────────────────────────────────────────────────────┘
```

---

## 4. 해결 방안

### 4.1 Phase 1: NewLanding에 트래킹 추가 (필수)

**수정 파일**: `src/pages/new-landing/App.tsx`

**Before:**
```typescript
import React from 'react';
import { Hero } from './components/Hero';
import { PWAProvider } from '@/components/pwa';

const App: React.FC = () => {
  return (
    <PWAProvider>
      <div className="h-screen w-screen overflow-hidden">
        <Hero />
      </div>
    </PWAProvider>
  );
};
```

**After:**
```typescript
import React from 'react';
import { Hero } from './components/Hero';
import { PWAProvider } from '@/components/pwa';
import { useActivityTracking } from '@/lib/hooks/useActivityTracking';

const App: React.FC = () => {
  // 사용자 활동 트래킹 (페이지뷰 자동 기록)
  useActivityTracking();

  return (
    <PWAProvider>
      <div className="h-screen w-screen overflow-hidden">
        <Hero />
      </div>
    </PWAProvider>
  );
};
```

**예상 효과**: 메인 페이지 방문자 트래킹 시작

### 4.2 Phase 2: 다른 페이지에도 트래킹 추가 (권장)

| 페이지 | 파일 | 상태 |
|--------|------|------|
| NewLanding | `src/pages/new-landing/App.tsx` | ❌ → ✅ (Phase 1) |
| MobileSearch | `src/pages/MobileSearch.tsx` | ❌ → ✅ |
| MobileRegister | `src/pages/MobileRegister.tsx` | ❌ → ✅ |
| MobileChat | `src/pages/MobileChat.tsx` | ❌ → ✅ |
| MobileChatRoom | `src/pages/MobileChatRoom.tsx` | ❌ → ✅ |
| DeveloperPage | `src/pages/DeveloperPage.tsx` | ❌ → ✅ |

### 4.3 Phase 3: Edge Function 배포 및 확인

**확인 필요 사항:**
1. `dashboard-analytics` Edge Function이 Supabase에 배포되어 있는지
2. 환경변수 설정 확인:
   - `SUPABASE_URL` 또는 `PROJECT_URL`
   - `SUPABASE_SERVICE_ROLE_KEY` 또는 `SERVICE_ROLE_KEY`

**배포 명령:**
```bash
supabase functions deploy dashboard-analytics
```

**환경변수 설정:**
```bash
supabase secrets set SUPABASE_SERVICE_ROLE_KEY=your_service_role_key
```

### 4.4 Phase 4: 지역 정보 개선 (선택)

현재 `useGeolocation` 훅이 위치 정보를 localStorage에 저장하고 있으나:
- 위치 정보 허용 팝업 거부 시 → 미분류
- VPN 사용 시 → 부정확

**개선 방안:**
1. 검색/필터 시 선택한 지역을 Fallback으로 사용
2. IP 기반 지역 추정 (외부 API 필요)

---

## 5. 작업 우선순위

### 즉시 필요 (Critical)

| # | 작업 | 예상 시간 |
|---|------|----------|
| 1 | NewLanding에 `useActivityTracking` 추가 | 5분 |
| 2 | Edge Function 배포 상태 확인 | 10분 |
| 3 | Edge Function 환경변수 확인/설정 | 10분 |

### 권장 (Important)

| # | 작업 | 예상 시간 |
|---|------|----------|
| 4 | 다른 페이지에도 트래킹 추가 | 20분 |
| 5 | 빌드 및 배포 | 10분 |
| 6 | 프로덕션 테스트 | 10분 |

### 선택 (Nice to have)

| # | 작업 | 예상 시간 |
|---|------|----------|
| 7 | 지역 정보 Fallback 로직 추가 | 30분 |
| 8 | RegionStats 미분류 표시 추가 | 15분 |

---

## 6. 테스트 체크리스트

### 트래킹 테스트
- [ ] 메인 페이지 접속 시 콘솔에 `[ActivityTracking]` 로그 확인
- [ ] `user_activity_logs` 테이블에 데이터 INSERT 확인
- [ ] 위치 정보 허용 시 `region_city` 값 확인

### 대시보드 테스트
- [ ] Edge Function 호출 시 200 응답 확인
- [ ] DAU/WAU/MAU 값이 0이 아닌지 확인
- [ ] 지역별 접속 현황에 데이터 표시 확인

---

## 7. 관련 문서

- [260127_관리자페이지_개선플랜.md](./260127_관리자페이지_개선플랜.md)
- [260127_관리자페이지_개선플랜_v2.md](./260127_관리자페이지_개선플랜_v2.md)

---

## 8. 스크린샷

### 현재 대시보드 상태 (2026-01-28)

![대시보드 스크린샷](./260128_dashboard_screenshot.png)

- 모든 지표 0
- "아직 수집된 방문 데이터가 없습니다" 메시지
- Edge Function 호출 실패

---

## 9. 결론

### 근본 원인
1. **NewLanding에 트래킹 코드 미적용** → 사용자 방문 기록 0건
2. **Edge Function 배포/설정 문제** → 대시보드 데이터 조회 실패

### 해결 순서
1. NewLanding에 `useActivityTracking()` 한 줄 추가
2. Edge Function 배포 및 환경변수 확인
3. 빌드/배포 후 프로덕션 테스트

### 예상 결과
- 즉시 사용자 방문 데이터 수집 시작
- 대시보드에 실제 DAU/WAU/MAU 표시
- 지역별/디바이스별 통계 확인 가능

---

*작성: Claude Code*
*테스트 환경: Playwright (Chrome)*
