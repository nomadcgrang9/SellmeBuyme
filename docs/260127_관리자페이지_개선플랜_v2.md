# 260127 관리자페이지 개선플랜 v2

> 작성일: 2026-01-27  
> 수정일: 2026-01-27 (지역 통계 부분 정정)  
> 목표: 관리자 페이지 통합 및 대시보드 사용량 통계 정상화

---

## 핵심 수정사항 (v2)

**지역 통계 관련 중요한 발견:**
- ❌ **회원가입 폼 없음** (예전 흔적만 존재, 현재 미사용)
- ✅ **위치정보 API 이미 구현됨** (useGeolocation 훅 존재)
- ✅ **Kakao API로 좌표→주소 변환 작동 중**
- ❌ **localStorage 데이터 구조 불일치로 읽기 실패**

→ **해결책: localStorage 읽기 구조만 1줄 수정하면 완료 (5분 작업)**

---

## 2.3 대시보드 지역 통계 수정 (Phase 2)

### 현황 파악

**이미 구현된 것들:**
```
✅ useGeolocation 훅 존재 (src/lib/hooks/useGeolocation.ts)
✅ 브라우저 위치정보 API (navigator.geolocation) 사용
✅ Kakao REST API로 좌표→주소 변환 (reverseGeocode)
✅ App.tsx에서 useGeolocation 호출 중 (Line 188)
✅ localStorage에 24시간 캐시 저장 중
```

**문제점:**
```
❌ 저장하는 구조 ≠ 읽는 구조
```

### 데이터 구조 불일치 상세

**저장 (useGeolocation.ts Line 72-77):**
```typescript
localStorage.setItem('user_location', JSON.stringify({
  coords: { latitude: 37.5, longitude: 127.1 },
  address: {                    // ← address 객체 안에 저장
    city: "성남",
    district: "분당"
  },
  timestamp: 1706345678901
}));
```

**읽기 (useActivityTracking.ts Line 31-44 - 현재 코드):**
```typescript
const getRegionInfo = (): { city?: string; district?: string } => {
  const cached = localStorage.getItem('user_location');
  if (cached) {
    const parsed = JSON.parse(cached);
    return {
      city: parsed.city,        // ❌ undefined (city가 최상위에 없음!)
      district: parsed.district // ❌ undefined
    };
  }
  return {};
};
```

### 해결 방법

#### 방안 A: localStorage 읽기 구조 수정 (권장)

**수정 위치:** `src/lib/hooks/useActivityTracking.ts` Line 35-36

**Before:**
```typescript
return {
  city: parsed.city,        // ❌
  district: parsed.district // ❌
};
```

**After:**
```typescript
return {
  city: parsed.address?.city || undefined,        // ✅
  district: parsed.address?.district || undefined // ✅
};
```

**작업 시간:** 5분  
**효과:** 즉시 지역 통계 작동

---

#### 방안 B: 위치정보 거부 시 Fallback 추가 (선택)

```typescript
const getRegionInfo = (): { city?: string; district?: string } => {
  // 1. 우선순위: localStorage 위치정보
  const cached = localStorage.getItem('user_location');
  if (cached) {
    const parsed = JSON.parse(cached);
    if (parsed.address?.city) {
      return {
        city: parsed.address.city,
        district: parsed.address.district
      };
    }
  }

  // 2. Fallback: 최근 검색/필터한 지역
  const lastSearch = localStorage.getItem('last_search_region');
  if (lastSearch) {
    return { city: lastSearch };
  }

  // 3. 미분류
  return {};
};
```

**장점:** 위치정보 거부해도 검색 기록으로 통계 가능  
**단점:** 검색 시 지역 저장 로직 추가 필요

---

### 위치정보 수집 흐름 (현재 시스템)

```
사용자 접속
    ↓
App.tsx → useGeolocation() 자동 호출
    ↓
브라우저 "위치정보 허용하시겠습니까?" 팝업
    ↓
    ├─ 허용 → navigator.geolocation.getCurrentPosition()
    │         ↓
    │      좌표 획득 (latitude, longitude)
    │         ↓
    │      Kakao REST API 호출 (reverseGeocode)
    │         ↓
    │      주소 변환 ("경기도 성남시 분당구")
    │         ↓
    │      localStorage 저장 (24시간 캐시)
    │         {
    │           coords: {...},
    │           address: { city: "성남", district: "분당" },
    │           timestamp: ...
    │         }
    │
    └─ 거부 → 저장 안 됨 → "미분류"로 처리
```

---

### RegionStats 수정

**현재 문제:** 17개 시도만 표시하므로 "성남", "수원" 같은 시/군 이름은 통계에 안 나옴

**Option 1: 시/군 이름 그대로 표시 (간단)**

`RegionStats.tsx` Line 18-21:
```typescript
const ALL_REGIONS = [
  '서울', '부산', '대구', '인천', '광주', '대전', '울산', '세종',
  '경기', '강원', '충북', '충남', '전북', '전남', '경북', '경남', '제주',
  '미분류'  // 추가
];
```

→ 17개 시도 외 데이터는 '기타' 섹션으로 별도 표시

**Option 2: 시/군 → 광역시도 매핑 (정석)**

`geocoding.ts`에 매핑 추가:
```typescript
const CITY_TO_PROVINCE: Record<string, string> = {
  '성남': '경기', '수원': '경기', '용인': '경기', '고양': '경기',
  '강남': '서울', '종로': '서울', '송파': '서울',
  '부산진': '부산', '해운대': '부산',
  // ... 전체 매핑
};
```

→ Edge Function에서 변환 후 저장

---

## 작업 우선순위 (수정)

### Phase 1: 관리자 페이지 통합 (30분~1시간)

1. [ ] TeamConsolePage 크롤링 탭 활성화 (Line 37 주석 해제)
2. [ ] TeamConsolePage 배너 관리 추가 (AdminPage 코드 복사)
3. [ ] main.tsx에서 AdminPage 라우팅 제거
4. [ ] AdminPage.tsx deprecated 처리

### Phase 2: 대시보드 통계 수정 (5~30분)

**최소 작업 (5분):**
1. [ ] useActivityTracking.ts Line 35-36 수정
   ```typescript
   city: parsed.address?.city || undefined,
   district: parsed.address?.district || undefined,
   ```

**추가 개선 (선택, +25분):**
2. [ ] RegionStats.tsx에 '미분류' 표시 추가
3. [ ] Fallback 로직 추가 (검색 기록 활용)
4. [ ] 시/군 → 광역시도 매핑 (정석 방법 선택 시)

---

## 지역 통계 정확도

**실제 동작:**
- ✅ 브라우저 위치정보 API 사용 (GPS/Wi-Fi/IP 기반)
- ✅ Kakao REST API로 정확한 주소 변환
- ✅ 24시간 캐시로 API 호출 최소화

**정확도:**
- 모바일 (GPS): 매우 높음 (수십 미터)
- 데스크톱 (Wi-Fi/IP): 중간 (수백 미터~수 km)
- 위치정보 거부: 미분류 처리

**제한사항:**
- VPN 사용자: 부정확 가능
- 해외 접속: Kakao API 한국 외 지역 제한적
- 위치정보 거부율: 일반적으로 30~50%

---

## 결론

**총 예상 작업 시간:**
- Phase 1 (관리자 페이지 통합): 30분~1시간
- Phase 2 (지역 통계 수정): **5~30분**
- **합계: 약 1~1.5시간**

**핵심 개선점:**
1. 관리자 페이지 1개로 통합 (비밀번호만으로 접근)
2. 지역 통계 1줄 수정으로 즉시 작동
3. 기존 위치정보 시스템 활용 (추가 구현 불필요)

---

*작성: Claude Code*  
*v2 업데이트: 지역 통계 부분 정정 (회원가입 폼 없음, localStorage 구조 불일치 발견)*
