# 크롤링 문제 개선 플랜 (2026.01.22)

## 목표
- GitHub 저장소 Public 전환
- GitHub Actions 크롤링 무료 범위 활용
- 크롤링 빈도/개수 증가

---

## 팩트 체크 및 현황 분석

### 1. GitHub Actions 크롤링 무료 여부 ✅ **맞음**
- **Public 저장소**: 월 2,000분 무료
- **Private 저장소**: 월 2,000분 무료 (동일)
- 현재 크롤러는 1회 실행 시 약 **5-10분** 소요
- 하루 2회 자동 실행 → 월 약 **600분** 사용
- **결론**: 충분히 무료 범위 내

### 2. API 키 노출 방지 필요 ✅ **맞음**
- 카카오 지도 키, Supabase 키 등 하드코딩 제거 필수

### 3. 현재 하드코딩 상태 ✅ **맞음**
```typescript
// src/hooks/useKakaoMaps.ts:22
const KAKAO_APP_KEY = import.meta.env.VITE_KAKAO_MAP_KEY || '69b6d6d11aa571c7001a92ba25a99c49';
```

### 4. Cloudflare 변수 추가했는데 실패 ❌ **환경변수 이름 불일치**

#### 근본 원인 발견

| 위치 | 환경변수 이름 | 상태 |
|------|--------------|------|
| **코드** (useKakaoMaps.ts) | `VITE_KAKAO_MAP_KEY` | ✅ |
| **문서** (CLOUDFLARE_ENV_SETUP.md) | `VITE_KAKAO_MAP_KEY` | ✅ |
| **로컬 .env** | `VITE_KAKAO_MAPS_APP_KEY` | ❌ **불일치** |

#### 왜 로컬에서 작동했나?
1. `.env`의 `VITE_KAKAO_MAPS_APP_KEY`는 사용되지 않음
2. 코드에서 `VITE_KAKAO_MAP_KEY`를 찾음 → `undefined`
3. **fallback 하드코딩 키 작동** → 지도 정상 표시

#### Cloudflare에서 실패한 이유 (추정)
1. Cloudflare에 `VITE_KAKAO_MAP_KEY` 설정 ✅
2. 하드코딩 제거 후 배포
3. 빌드 시점에 환경변수가 주입되어야 하는데...
4. **Cloudflare Pages는 빌드 시 환경변수를 올바르게 주입함**
5. 하지만 **다른 문제**가 있었을 가능성:
   - 카카오 도메인 등록 문제
   - 새 키 발급 시 활성화 지연
   - 브라우저 캐시

---

## 해결 방안

### **Phase 1: 환경변수 이름 통일**

#### 1. `.env` 파일 수정
```bash
# 변경 전
VITE_KAKAO_MAPS_APP_KEY=...

# 변경 후
VITE_KAKAO_MAP_KEY=...
```

#### 2. 로컬 테스트
```bash
npm run dev
# 지도가 정상 작동하는지 확인
# 콘솔에서 fallback 경고가 안 나오는지 확인
```

---

### **Phase 2: Cloudflare Pages 환경변수 확인**

1. Cloudflare 대시보드 접속
2. `VITE_KAKAO_MAP_KEY`가 **Production과 Preview 모두**에 설정되어 있는지 확인
3. 카카오 개발자 콘솔에서 **도메인 등록** 확인:
   - `sellmebuyme.pages.dev` (Cloudflare Pages 기본 도메인)
   - 커스텀 도메인 (있다면)

---

### **Phase 3: 안전한 Public 전환 절차**

#### **Step 1: 로컬 하드코딩 제거 + 테스트**

```typescript
// useKakaoMaps.ts - 수정
const KAKAO_APP_KEY = import.meta.env.VITE_KAKAO_MAP_KEY;

if (!KAKAO_APP_KEY) {
  throw new Error('[useKakaoMaps] VITE_KAKAO_MAP_KEY 환경변수가 설정되지 않았습니다. .env 파일을 확인하세요.');
}
```

- 로컬에서 지도 작동 확인
- 환경변수 없을 시 명확한 에러 메시지

#### **Step 2: 커밋 전 .gitignore 확인**

```bash
# .gitignore에 .env 포함되어 있는지 확인
cat .gitignore | grep "\.env"
```

#### **Step 3: 점진적 배포**

1. **하드코딩 제거 커밋 + 푸시**
2. Cloudflare Pages 빌드 로그 확인:
   - `VITE_KAKAO_MAP_KEY` 환경변수 주입 확인
3. **Preview 환경에서 먼저 테스트**
4. Preview 정상 작동 확인 후 → Production 배포

#### **Step 4: Public 전환 직전 체크리스트**

- [ ] 로컬 .env 파일의 모든 키를 Cloudflare Pages에 추가
- [ ] 카카오 개발자 콘솔에서 도메인 등록
- [ ] Supabase RLS 정책 검토
- [ ] GitHub Actions Secrets 검토 (SUPABASE_SERVICE_ROLE_KEY, GEMINI_API_KEY는 노출 금지)
- [ ] README에 민감 정보 없는지 확인
- [ ] 커밋 히스토리에 키 하드코딩 없는지 확인

---

## 크롤링 개수 늘리기 안전 전략

### 현재 상황
- 하루 2회 자동 실행 (10 AM, 6 PM KST)
- 17개 지역 크롤러
- GitHub Actions 무료 한도: 월 2,000분

### 증설 방안
1. **실행 빈도 증가**: 하루 3회 → 월 900분 (여유 충분)
2. **배치 크기 증가**: `crawl_boards.crawl_batch_size` 10 → 20
3. **병렬 실행**: Matrix strategy 활용 (이미 구현됨)

### 모니터링
- GitHub Actions 사용량: Settings → Billing
- 크롤러 실패율: `crawl_boards.error_count`
- 월말 기준 1,800분 초과 시 → 빈도 조정

---

## 최종 권장 순서

```bash
# 1. 로컬 환경변수 이름 수정
# .env 파일에서 VITE_KAKAO_MAPS_APP_KEY → VITE_KAKAO_MAP_KEY

# 2. 로컬 테스트
npm run dev
# 지도 정상 작동 + fallback 경고 없는지 확인

# 3. Cloudflare Pages 환경변수 재확인
# 이미 설정했다면 OK, 아니면 추가

# 4. 하드코딩 제거 (useKakaoMaps.ts 수정)

# 5. 커밋 + 푸시
git add .
git commit -m "security: Remove hardcoded Kakao API key"
git push

# 6. Cloudflare Preview 환경 테스트

# 7. 정상 작동 확인 후 Public 전환
```

---

## 핵심 요약

**환경변수 이름 불일치가 근본 원인**이었고, Cloudflare는 제대로 작동하고 있었을 가능성이 높습니다.

### 즉시 해야 할 작업 (우선순위 순)
1. ✅ `.env` 파일 환경변수 이름 수정
2. ✅ 로컬 테스트 (fallback 경고 확인)
3. ✅ 하드코딩 제거
4. ✅ Cloudflare 환경변수 확인
5. ✅ 배포 후 Preview 환경 테스트
6. ✅ Public 전환

---

## 참고 문서
- [docs/CLOUDFLARE_ENV_SETUP.md](./CLOUDFLARE_ENV_SETUP.md)
- [docs/PUBLIC_CONVERSION_CHECKLIST.md](./PUBLIC_CONVERSION_CHECKLIST.md)
- [.env.example](../.env.example)
