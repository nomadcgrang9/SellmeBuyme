# 크롤링 문제 개선 플랜 (2026.01.22)

## 목표
- GitHub 저장소 Public 전환
- GitHub Actions 크롤링 무료 범위 활용
- 크롤링 빈도/개수 증가

---

## 팩트 체크 및 현황 분석

### 1. GitHub Actions 크롤링 무료 여부 ✅ **맞음**
- **Public 저장소**: 월 2,000분 무료
- **Private 저장소**: 월 2,000분 무료 (동일)
- 현재 크롤러는 1회 실행 시 약 **5-10분** 소요
- 하루 2회 자동 실행 → 월 약 **600분** 사용
- **결론**: 충분히 무료 범위 내

### 2. API 키 노출 방지 필요 ✅ **맞음**
- 카카오 지도 키, Supabase 키 등 하드코딩 제거 필수

### 3. 현재 하드코딩 상태 ✅ **맞음**
```typescript
// src/hooks/useKakaoMaps.ts:22
const KAKAO_APP_KEY = import.meta.env.VITE_KAKAO_MAP_KEY || '69b6d6d11aa571c7001a92ba25a99c49';
```

### 4. Cloudflare 변수 추가했는데 실패 ❌ **환경변수 이름 불일치**

#### 근본 원인 발견

| 위치 | 환경변수 이름 | 상태 |
|------|--------------|------|
| **코드** (useKakaoMaps.ts) | `VITE_KAKAO_MAP_KEY` | ✅ |
| **문서** (CLOUDFLARE_ENV_SETUP.md) | `VITE_KAKAO_MAP_KEY` | ✅ |
| **로컬 .env** | `VITE_KAKAO_MAPS_APP_KEY` | ❌ **불일치** |

#### 왜 로컬에서 작동했나?
1. `.env`의 `VITE_KAKAO_MAPS_APP_KEY`는 사용되지 않음
2. 코드에서 `VITE_KAKAO_MAP_KEY`를 찾음 → `undefined`
3. **fallback 하드코딩 키 작동** → 지도 정상 표시

#### Cloudflare에서 실패한 이유 (추정)
1. Cloudflare에 `VITE_KAKAO_MAP_KEY` 설정 ✅
2. 하드코딩 제거 후 배포
3. 빌드 시점에 환경변수가 주입되어야 하는데...
4. **Cloudflare Pages는 빌드 시 환경변수를 올바르게 주입함**
5. 하지만 **다른 문제**가 있었을 가능성:
   - 카카오 도메인 등록 문제
   - 새 키 발급 시 활성화 지연
   - 브라우저 캐시

---

## 해결 방안

### **Phase 1: 환경변수 이름 통일**

#### 1. `.env` 파일 수정
```bash
# 변경 전
VITE_KAKAO_MAPS_APP_KEY=...

# 변경 후
VITE_KAKAO_MAP_KEY=...
```

#### 2. 로컬 테스트
```bash
npm run dev
# 지도가 정상 작동하는지 확인
# 콘솔에서 fallback 경고가 안 나오는지 확인
```

---

### **Phase 2: Cloudflare Pages 환경변수 확인**

1. Cloudflare 대시보드 접속
2. `VITE_KAKAO_MAP_KEY`가 **Production과 Preview 모두**에 설정되어 있는지 확인
3. 카카오 개발자 콘솔에서 **도메인 등록** 확인:
   - `sellmebuyme.pages.dev` (Cloudflare Pages 기본 도메인)
   - 커스텀 도메인 (있다면)

---

### **Phase 3: 안전한 Public 전환 절차**

#### **Step 1: 로컬 하드코딩 제거 + 테스트**

```typescript
// useKakaoMaps.ts - 수정
const KAKAO_APP_KEY = import.meta.env.VITE_KAKAO_MAP_KEY;

if (!KAKAO_APP_KEY) {
  throw new Error('[useKakaoMaps] VITE_KAKAO_MAP_KEY 환경변수가 설정되지 않았습니다. .env 파일을 확인하세요.');
}
```

- 로컬에서 지도 작동 확인
- 환경변수 없을 시 명확한 에러 메시지

#### **Step 2: 커밋 전 .gitignore 확인**

```bash
# .gitignore에 .env 포함되어 있는지 확인
cat .gitignore | grep "\.env"
```

#### **Step 3: 점진적 배포**

1. **하드코딩 제거 커밋 + 푸시**
2. Cloudflare Pages 빌드 로그 확인:
   - `VITE_KAKAO_MAP_KEY` 환경변수 주입 확인
3. **Preview 환경에서 먼저 테스트**
4. Preview 정상 작동 확인 후 → Production 배포

#### **Step 4: Public 전환 직전 체크리스트**

- [ ] 로컬 .env 파일의 모든 키를 Cloudflare Pages에 추가
- [ ] 카카오 개발자 콘솔에서 도메인 등록
- [ ] Supabase RLS 정책 검토
- [ ] GitHub Actions Secrets 검토 (SUPABASE_SERVICE_ROLE_KEY, GEMINI_API_KEY는 노출 금지)
- [ ] README에 민감 정보 없는지 확인
- [ ] 커밋 히스토리에 키 하드코딩 없는지 확인

---

## 크롤링 개수 늘리기 안전 전략

### 현재 상황
- 하루 2회 자동 실행 (10 AM, 6 PM KST)
- 17개 지역 크롤러
- GitHub Actions 무료 한도: 월 2,000분

### 증설 방안
1. **실행 빈도 증가**: 하루 3회 → 월 900분 (여유 충분)
2. **배치 크기 증가**: `crawl_boards.crawl_batch_size` 10 → 20
3. **병렬 실행**: Matrix strategy 활용 (이미 구현됨)

### 모니터링
- GitHub Actions 사용량: Settings → Billing
- 크롤러 실패율: `crawl_boards.error_count`
- 월말 기준 1,800분 초과 시 → 빈도 조정

---

## 최종 권장 순서

```bash
# 1. 로컬 환경변수 이름 수정
# .env 파일에서 VITE_KAKAO_MAPS_APP_KEY → VITE_KAKAO_MAP_KEY

# 2. 로컬 테스트
npm run dev
# 지도 정상 작동 + fallback 경고 없는지 확인

# 3. Cloudflare Pages 환경변수 재확인
# 이미 설정했다면 OK, 아니면 추가

# 4. 하드코딩 제거 (useKakaoMaps.ts 수정)

# 5. 커밋 + 푸시
git add .
git commit -m "security: Remove hardcoded Kakao API key"
git push

# 6. Cloudflare Preview 환경 테스트

# 7. 정상 작동 확인 후 Public 전환
```

---

## 핵심 요약

**환경변수 이름 불일치가 근본 원인**이었고, Cloudflare는 제대로 작동하고 있었을 가능성이 높습니다.

### 즉시 해야 할 작업 (우선순위 순)
1. ✅ `.env` 파일 환경변수 이름 수정
2. ✅ 로컬 테스트 (fallback 경고 확인)
3. ✅ 하드코딩 제거
4. ✅ Cloudflare 환경변수 확인
5. ✅ 배포 후 Preview 환경 테스트
6. ✅ Public 전환

---

## 대화 로그 (2026.01.22)

### 사용자 발화 1
> 퍼블릭 전환 관련 다시 생각해보자. 1. 퍼블릭이 되면 깃액션즈 크롤링 추가해도 무료이다 2. 현재 상황에서 퍼블릭하려면 API키 값이나 다양한 키 값들이 노출되지 않아야 하는데 3. 현재 전수조사하니 카카오키값이 하드코딩된 상태이다 4. 로컬에서 이 키값을 제거하고 클라우드플레어 변수에 추가하면 된다. 5. 그럴줄 알고 제거 후 플레어 변수에 실제로 추가도 했는데 맵이 아예 로딩이 안되는 문제가 생겼다. 6. 고치려고 몇 번을 했는데 계속 고치질 못해서 결국 폴백하고 로컬에 다시 하드코딩한 상황이다

### AI 답변 1
- **팩트 체크 완료**: 위 분석 내용 참조
- **근본 원인 발견**: 환경변수 이름 불일치
  - 코드: `VITE_KAKAO_MAP_KEY`
  - 로컬 .env: `VITE_KAKAO_MAPS_APP_KEY` (불일치)
- **해결 방안**: Phase 1-3 제시

### 사용자 발화 2
> 배포했다고 했는데 배포 클라우드플레어에 변경사항 없음으로 배포 안되고 있어. 대체 뭐야?

### AI 답변 2
- **빌드 실패 원인 확인**: Cloudflare 빌드 로그 분석
- **TypeScript 에러 3개 발견**:
  ```
  error TS2339: Property 'selectJobFromMarker' does not exist on type 'Window'
  error TS2322: Type 'void' is not assignable to type 'ReactNode'
  ```
- **수정 완료**: Window 타입 정의 추가, JSX 내 console.log 제거
- **커밋**: `08cb708` - fix: TypeScript 빌드 에러 수정

### 사용자 발화 3
> 이 내용 크롤링 문제 개선플랜 260122 엠디 파일에 우선 기록해놔. 내일 이어서 하게

### AI 답변 3
- **문서 작성 완료**: `docs/크롤링문제개선플랜_260122.md`
- **커밋**: `77ed40d` - docs: 크롤링 문제 개선 플랜 작성

---

## 카카오맵 API 키 이슈 상세 기록

### 배경: 왜 이 이슈가 발생했는가?

#### 1. 크롤링 횟수/개수 증가 필요
- 현재 하루 2회, 배치 크기 10개로 제한
- 더 많은 공고 수집 필요

#### 2. GitHub Actions 무료 범위 활용하려면 Public 전환 필수
- **Private 저장소**: 월 2,000분 무료 (현재 사용 중)
- **Public 저장소**: 월 2,000분 무료 (동일하지만 제한 없음)
- 크롤링 빈도 증가 시 Public 전환이 안전

#### 3. Public 전환 시 API 키 노출 문제
- 코드에 하드코딩된 키가 있으면 전세계에 공개됨
- 카카오 지도 키, Supabase 키 등 민감 정보 노출 위험

### 문제 발생 경위

#### Step 1: 하드코딩 제거 시도
```typescript
// 변경 전 (src/hooks/useKakaoMaps.ts)
const KAKAO_APP_KEY = import.meta.env.VITE_KAKAO_MAP_KEY || '69b6d6d11aa571c7001a92ba25a99c49';

// 변경 후 (하드코딩 제거)
const KAKAO_APP_KEY = import.meta.env.VITE_KAKAO_MAP_KEY;
```

#### Step 2: Cloudflare Pages 환경변수 등록
- Cloudflare 대시보드 → Settings → Environment variables
- `VITE_KAKAO_MAP_KEY` 추가 완료

#### Step 3: 배포 후 지도 로딩 실패
- 지도가 아예 표시되지 않음
- SDK 로드 실패 에러 발생:
  ```
  [useKakaoMaps] ❌ VITE_KAKAO_MAP_KEY 환경변수가 설정되지 않았습니다.
  <script> 엘리먼트의 'src' 속성이 빈값입니다.
  ```

#### Step 4: 여러 번 수정 시도 → 계속 실패

#### Step 5: 롤백 결정
- fallback 키 다시 추가 (하드코딩 복구)
- 커밋: `966cad8` - hotfix: Kakao Maps SDK 로드 실패 긴급 복구

### 현재 상태 (미해결)

| 항목 | 상태 |
|------|------|
| **하드코딩** | ✅ 복구됨 (fallback 키 존재) |
| **지도 작동** | ✅ 정상 (fallback 키로 작동) |
| **Public 전환** | ❌ 불가 (키 노출 위험) |
| **크롤링 증가** | ❌ 보류 |

### 근본 원인 (분석 완료)

**환경변수 이름 불일치**:
- 로컬 `.env`: `VITE_KAKAO_MAPS_APP_KEY`
- 코드: `VITE_KAKAO_MAP_KEY`
- 로컬에서는 fallback 키가 작동해서 문제 인지 못함

### 다음 작업 (TODO)

1. [ ] `.env` 파일에서 `VITE_KAKAO_MAPS_APP_KEY` → `VITE_KAKAO_MAP_KEY`로 수정
2. [ ] 로컬 테스트 (fallback 경고 없이 지도 작동 확인)
3. [ ] 하드코딩 제거 후 재배포
4. [ ] Cloudflare Preview 환경 테스트
5. [ ] 성공 시 Public 전환
6. [ ] 크롤링 빈도/배치 크기 증가

---

## 서울교육일자리포털 크롤러 수정 (2026.01.23)

### 문제
- 서울 job_postings: **0건** (약 한 달간 크롤링 실패)
- 원인: 웹사이트 HTML 구조 변경으로 셀렉터 무효화

### 수정 내용

#### 1. 셀렉터 변경 (`crawler/sources/seoul.js`)
```javascript
// 변경 전
const DEFAULT_SELECTORS = {
  listContainer: '#srchDataDiv',
  rows: '#srchDataDiv > ul > li'
};

// 변경 후
const DEFAULT_SELECTORS = {
  listContainer: 'article ul',
  rows: 'article ul > li'
};
```

#### 2. 제목/링크 추출 로직 강화
```javascript
// 여러 셀렉터 시도 (구조 변경 대응)
const titleLink = el.querySelector('.list_title a')
  || el.querySelector('h4 a')
  || el.querySelector('a[href*="rcrtSn"]')
  || el.querySelector('a');
```

#### 3. Supabase crawl_boards 업데이트
```sql
UPDATE crawl_boards
SET region = '서울'
WHERE name = '서울교육일자리포털';
```

### 커밋
- `7627afb` - fix: 서울교육일자리포털 크롤러 셀렉터 수정

### 검증 대기
- [ ] GitHub Actions 다음 실행에서 items_found > 0 확인
- [ ] Supabase에서 서울 job_postings 개수 증가 확인

---

## 참고 문서
- [docs/CLOUDFLARE_ENV_SETUP.md](./CLOUDFLARE_ENV_SETUP.md)
- [docs/PUBLIC_CONVERSION_CHECKLIST.md](./PUBLIC_CONVERSION_CHECKLIST.md)
- [.env.example](../.env.example)
