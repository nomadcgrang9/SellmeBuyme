# GitHub Actions - 배포 추적 (수정 버전)
name: Track Deployment

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  track:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Track deployment to Supabase
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          # 직접 Supabase REST API로 삽입 (Edge Function 우회)
          curl -X POST "$SUPABASE_URL/rest/v1/github_deployments" \
            -H "apikey: $SUPABASE_SERVICE_ROLE_KEY" \
            -H "Authorization: Bearer $SUPABASE_SERVICE_ROLE_KEY" \
            -H "Content-Type: application/json" \
            -H "Prefer: return=representation" \
            -d "{
              \"commit_sha\": \"${{ github.sha }}\",
              \"commit_message\": $(echo '${{ github.event.head_commit.message }}' | jq -Rs .),
              \"branch\": \"${{ github.ref_name }}\",
              \"author\": \"${{ github.event.head_commit.author.name }}\",
              \"status\": \"success\",
              \"workflow_run_id\": \"${{ github.run_id }}\",
              \"deployed_at\": \"${{ github.event.head_commit.timestamp }}\"
            }"
