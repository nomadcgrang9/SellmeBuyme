# GitHub Actions - ë°°í¬ ì¶”ì  (ìˆ˜ì • ë²„ì „)
name: Track Deployment

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  track:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Track deployment to Supabase
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          # ì§ì ‘ Supabase REST APIë¡œ ì‚½ì… (Edge Function ìš°íšŒ)
          echo "ğŸš€ ë°°í¬ ê¸°ë¡ ì¤‘..."

          # HTTP ì‘ë‹µ ì½”ë“œì™€ í•¨ê»˜ curl ì‹¤í–‰
          RESPONSE=$(curl -w "\n%{http_code}" -X POST "$SUPABASE_URL/rest/v1/github_deployments" \
            -H "apikey: $SUPABASE_SERVICE_ROLE_KEY" \
            -H "Authorization: Bearer $SUPABASE_SERVICE_ROLE_KEY" \
            -H "Content-Type: application/json" \
            -H "Prefer: return=representation" \
            -d "{
              \"commit_sha\": \"${{ github.sha }}\",
              \"commit_message\": $(echo '${{ github.event.head_commit.message }}' | jq -Rs .),
              \"branch\": \"${{ github.ref_name }}\",
              \"author\": \"${{ github.event.head_commit.author.name }}\",
              \"status\": \"success\",
              \"workflow_run_id\": \"${{ github.run_id }}\",
              \"deployed_at\": \"${{ github.event.head_commit.timestamp }}\"
            }")

          # HTTP ìƒíƒœ ì½”ë“œ ì¶”ì¶œ (ë§ˆì§€ë§‰ ì¤„)
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n-1)

          echo "HTTP ìƒíƒœ ì½”ë“œ: $HTTP_CODE"

          # 200-299 ë²”ìœ„ëŠ” ì„±ê³µ
          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "âœ… ë°°í¬ ê¸°ë¡ ì„±ê³µ!"
            exit 0
          else
            echo "âš ï¸ ë°°í¬ ê¸°ë¡ ì‹¤íŒ¨ (HTTP $HTTP_CODE)"
            echo "ì‘ë‹µ: $BODY"
            exit 1
          fi
