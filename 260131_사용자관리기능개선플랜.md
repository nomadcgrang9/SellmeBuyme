# 260131 사용자관리 기능개선 플랜

## 1. 현재 구조 (변경 없음)

| 항목 | 현재 상태 |
|------|-----------|
| 로그인 | 구글/카카오 소셜 로그인 |
| 저장 데이터 | `user_id`, `email`, `created_at` |
| 추가 프로필 | 수집 안 함 |

---

## 2. 구현 가능 기능

| 기능 | 쿼리/구현 |
|------|-----------|
| 총 가입자 | `COUNT(*)` |
| 7일/30일 신규 | `WHERE created_at >= NOW() - INTERVAL` |
| 이메일 검색 | `email ILIKE '%검색어%'` |
| 정렬 | `ORDER BY created_at DESC` |
| 비활성화 | `status = 'suspended'` |

---

## 3. RLS 정책 설계 (핵심)

### 3-1. 현재 문제

브라우저에서 `auth.uid()` 체크 시 권한 없음 오류 발생.

```
브라우저: OAuth 세션 → RLS auth.uid() 체크 → 막힘
```

### 3-2. 해결 방안: 팀콘솔 전용 RLS 우회

> [!IMPORTANT]
> 팀콘솔은 비밀번호 인증 후 접근하므로, **로그인 유저 + 팀콘솔 비밀번호 인증** 조합으로 권한 부여

**방법 A: 관리자 역할 기반 (권장)**

```sql
-- 마이그레이션 SQL
-- 20260131_admin_user_management.sql

-- 1. status 컬럼 추가
ALTER TABLE user_profiles 
ADD COLUMN IF NOT EXISTS status TEXT DEFAULT 'active';

-- 2. RLS 활성화
ALTER TABLE user_profiles ENABLE ROW LEVEL SECURITY;

-- 3. 기존 정책 전체 삭제 (충돌 방지)
DO $$ 
DECLARE 
  pol RECORD;
BEGIN
  FOR pol IN 
    SELECT policyname FROM pg_policies 
    WHERE tablename = 'user_profiles'
  LOOP
    EXECUTE format('DROP POLICY IF EXISTS %I ON user_profiles', pol.policyname);
  END LOOP;
END $$;

-- 4. 새 정책 생성

-- 4-1. 본인 프로필 조회
CREATE POLICY "본인 프로필 조회"
ON user_profiles FOR SELECT
USING (auth.uid() = user_id);

-- 4-2. 관리자 전체 조회 (roles에 'admin' 포함)
CREATE POLICY "관리자 전체 조회"
ON user_profiles FOR SELECT
USING (
  EXISTS (
    SELECT 1 FROM user_profiles admin_check
    WHERE admin_check.user_id = auth.uid()
    AND admin_check.roles @> ARRAY['admin']::text[]
  )
);

-- 4-3. 본인 프로필 수정
CREATE POLICY "본인 프로필 수정"
ON user_profiles FOR UPDATE
USING (auth.uid() = user_id)
WITH CHECK (auth.uid() = user_id);

-- 4-4. 관리자 프로필 수정 (status 등)
CREATE POLICY "관리자 프로필 수정"
ON user_profiles FOR UPDATE
USING (
  EXISTS (
    SELECT 1 FROM user_profiles admin_check
    WHERE admin_check.user_id = auth.uid()
    AND admin_check.roles @> ARRAY['admin']::text[]
  )
)
WITH CHECK (
  EXISTS (
    SELECT 1 FROM user_profiles admin_check
    WHERE admin_check.user_id = auth.uid()
    AND admin_check.roles @> ARRAY['admin']::text[]
  )
);
```

### 3-3. 관리자 지정

```sql
-- SQL Editor에서 실행
UPDATE user_profiles 
SET roles = ARRAY['admin']
WHERE email = '관리자이메일@example.com';
```

### 3-4. RLS 정책 검증 쿼리

```sql
-- 정책 확인
SELECT policyname, cmd, qual, with_check 
FROM pg_policies 
WHERE tablename = 'user_profiles';

-- 현재 유저가 조회 가능한지 테스트
SELECT * FROM user_profiles LIMIT 5;
```

---

## 4. 디자인 가이드 (anti-vibe-design 준수)

> 참조: `.claude/skills/anti-vibe-design/SKILL.md`

### 4-1. 절대 규칙

| 규칙 | 금지 | 허용 |
|------|------|------|
| 이모지 | ❌ 📊 👤 ✅ | 텍스트만 |
| 형광펜 | `bg-yellow-200` | `font-bold text-red-600` |
| 원색 | `bg-purple-600 text-pink-500` | 프로젝트 컬러만 |

### 4-2. 컬러 팔레트

| 용도 | 클래스 | HEX |
|------|--------|-----|
| 메인 | `bg-[#3B82F6]` | #3B82F6 |
| 강조 | `text-red-600` | #DC2626 |
| 본문 | `text-gray-800` | - |
| 보조 | `text-gray-600` | - |
| 테두리 | `border-gray-200` | - |

### 4-3. 컴포넌트 패턴

**KPI 카드**
```tsx
<div className="bg-white p-4 rounded-lg border border-gray-200">
  <p className="text-sm text-gray-600">총 가입자</p>
  <p className="text-2xl font-bold text-gray-800">127명</p>
</div>
```

**테이블 행**
```tsx
<tr className="border-b border-gray-100 hover:bg-gray-50">
  <td className="py-3 text-sm text-gray-800">hong@gmail.com</td>
  <td className="py-3 text-sm text-gray-600">01.28</td>
</tr>
```

**Primary 버튼**
```tsx
<button className="bg-[#3B82F6] text-white font-medium px-4 py-2 rounded-lg hover:bg-blue-600">
  비활성화
</button>
```

**Danger 버튼**
```tsx
<button className="bg-red-500 text-white font-medium px-4 py-2 rounded-lg hover:bg-red-600">
  삭제
</button>
```

---

## 5. 화면 구조

```
┌───────────────────────────────────────────────────────────────┐
│  팀 콘솔 > 사용자 관리                                        │
├───────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌───────────┐  ┌───────────┐  ┌───────────┐                 │
│  │ 총 127명  │  │ +12 (7일) │  │ +3 (오늘) │                 │
│  │ text-2xl  │  │ text-sm   │  │ text-sm   │                 │
│  └───────────┘  └───────────┘  └───────────┘                 │
│                                                               │
│  검색: [________________] (border-gray-200, focus:ring-blue)  │
│                                                               │
├─────────────────────────────────┬─────────────────────────────┤
│  이메일              가입일     │  선택된 사용자              │
├─────────────────────────────────┤                             │
│  hong@gmail.com     01.28      │  hong@gmail.com             │
│  kim@kakao.com      01.27      │  가입일: 2024.01.28         │
│  (hover:bg-gray-50)            │  상태: active               │
│                                 │                             │
│  < 1 2 3 >                     │  [비활성화] (bg-red-500)    │
└─────────────────────────────────┴─────────────────────────────┘
```

---

## 6. 구현 순서

| 순서 | 작업 | 비고 |
|------|------|------|
| 1 | SQL Editor에서 마이그레이션 실행 | RLS + status |
| 2 | 본인 계정에 roles = ['admin'] 추가 | 관리자 지정 |
| 3 | RLS 정책 검증 (`SELECT * FROM user_profiles`) | 전체 조회 확인 |
| 4 | AdminUserManagement.tsx 쿼리 수정 | user_profiles 직접 조회 |
| 5 | UI 구현 (anti-vibe-design 준수) | 컬러, 컴포넌트 패턴 |

---

## 7. 검증 체크리스트

**SQL 실행 후**
- [ ] `SELECT * FROM user_profiles LIMIT 5;` → 결과 있음
- [ ] status 컬럼 존재 확인
- [ ] 관리자 계정 roles = ['admin'] 확인

**팀콘솔 테스트**
- [ ] 사용자 목록 조회됨 (0명 아님)
- [ ] KPI 숫자 표시됨
- [ ] 검색 기능 동작
- [ ] 비활성화 클릭 시 status 변경됨

**디자인 체크**
- [ ] 이모지 없음
- [ ] 형광펜 배경 없음
- [ ] 프로젝트 컬러 사용 (#3B82F6, gray 계열)


