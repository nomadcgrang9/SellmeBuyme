<!doctype html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/png" href="/picture/favicon.png" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>í•™êµì¼ì„ ì°¾ëŠ” ê°€ì¥ ë¹ ë¥´ê³  í¸í•œ ë°©ë²• | í•™êµì¼ìë¦¬</title>

  <!-- PWA Manifest (ê¸°ë³¸: ë©”ì¸ ì„œë¹„ìŠ¤, /noteì—ì„œëŠ” JSë¡œ ë™ì  ë³€ê²½) -->
  <link rel="manifest" href="/manifest.webmanifest" id="pwa-manifest" />

  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#4a90d9" />
  <meta name="description" content="ì „êµ­ êµìœ¡ì²­, í•™êµ êµìœ¡ê³µë¬´ì§ ì±„ìš©ê³µê³ ë¥¼ í•œëˆˆì—. í•™êµì¼ìë¦¬ì—ì„œ ì‰½ê³  ë¹ ë¥´ê²Œ ì°¾ì•„ë³´ì„¸ìš”." />

  <!-- iOS Safari PWA Support -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="í•™êµì¼ìë¦¬" />
  <link rel="apple-touch-icon" href="/picture/faviconV2.png" />
</head>

<body>
  <!-- PWA Reset Script: ?reset-pwa=true íŒŒë¼ë¯¸í„°ë¡œ ìºì‹œ ì´ˆê¸°í™” -->
  <script>
    (function() {
      const params = new URLSearchParams(window.location.search);
      if (params.get('reset-pwa') === 'true') {
        console.log('ğŸ”„ PWA Reset ì‹œì‘...');

        // ë¡œë”© í‘œì‹œ
        document.addEventListener('DOMContentLoaded', function() {
          var root = document.getElementById('root');
          if (root) root.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100vh;font-family:sans-serif;flex-direction:column;gap:16px;"><p style="font-size:18px;">PWA ì´ˆê¸°í™” ì¤‘...</p><p style="color:#666;font-size:14px;">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”</p></div>';
        });

        var tasks = [];

        // 1. Service Worker ì–¸ë ˆì§€ìŠ¤í„° (ì™„ë£Œ ëŒ€ê¸°)
        if ('serviceWorker' in navigator) {
          tasks.push(
            navigator.serviceWorker.getRegistrations().then(function(registrations) {
              return Promise.all(registrations.map(function(registration) {
                console.log('âœ… Service Worker í•´ì œ:', registration.scope);
                return registration.unregister();
              }));
            })
          );
        }

        // 2. ìºì‹œ ì‚­ì œ (ì™„ë£Œ ëŒ€ê¸°)
        if ('caches' in window) {
          tasks.push(
            caches.keys().then(function(cacheNames) {
              return Promise.all(cacheNames.map(function(cacheName) {
                console.log('âœ… ìºì‹œ ì‚­ì œ:', cacheName);
                return caches.delete(cacheName);
              }));
            })
          );
        }

        // 3. localStorage/sessionStorage í´ë¦¬ì–´ (PWA ê´€ë ¨)
        ['main_pwa_visited', 'main_pwa_dismissed', 'devnote_pwa_visited', 'devnote_pwa_dismissed', 'pwa_install_prompted'].forEach(function(key) {
          localStorage.removeItem(key);
          sessionStorage.removeItem(key);
          sessionStorage.removeItem(key + '_session');
        });
        console.log('âœ… PWA ë°©ë¬¸ ê¸°ë¡ ì´ˆê¸°í™”');

        // 4. ëª¨ë“  ë¹„ë™ê¸° ì‘ì—… ì™„ë£Œ í›„ ë¦¬ë‹¤ì´ë ‰íŠ¸
        Promise.all(tasks).then(function() {
          console.log('âœ… ëª¨ë“  PWA ì´ˆê¸°í™” ì™„ë£Œ');
          params.delete('reset-pwa');
          var newUrl = window.location.pathname + (params.toString() ? '?' + params.toString() : '');
          console.log('ğŸ”„ ë¦¬ë‹¤ì´ë ‰íŠ¸:', newUrl);
          // ì•½ê°„ì˜ ë”œë ˆì´ í›„ ë¦¬ë‹¤ì´ë ‰íŠ¸ (ë¸Œë¼ìš°ì €ê°€ ë³€ê²½ì‚¬í•­ ë°˜ì˜í•˜ë„ë¡)
          setTimeout(function() {
            window.location.replace(newUrl);
          }, 300);
        }).catch(function(err) {
          console.error('âŒ PWA ì´ˆê¸°í™” ì˜¤ë¥˜:', err);
          // ì˜¤ë¥˜ê°€ ìˆì–´ë„ ë¦¬ë‹¤ì´ë ‰íŠ¸
          params.delete('reset-pwa');
          var newUrl = window.location.pathname + (params.toString() ? '?' + params.toString() : '');
          window.location.replace(newUrl);
        });

        return;
      }
    })();
  </script>

  <div id="root"></div>
  <script type="module" src="/src/main.tsx"></script>
</body>

</html>